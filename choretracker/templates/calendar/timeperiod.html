{% extends "base.html" %}

{% block title %}{{ entry.title }} instance - Chore Tracker{% endblock %}

{% block content %}
<h1><a href="{{ request.url_for('view_calendar_entry', entry_id=entry.id) }}">{{ entry.title }}</a> instance</h1>
<div class="time-range">
    <span>{{ time_range_summary(period.start, period.end) }}</span>
    {% for user in responsible %}
    <img src="{{ request.url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
    {% endfor %}
    {% if entry.type == CalendarEntryType.Chore %}
        {% if period.end <= now %}
            {% if not completion and user_has(request.session.get('user'), 'chores.complete_overdue') %}
            <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" data-action="add" />
            {% elif completion %}
            <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" {% if completion.completed_by == request.session.get('user') or user_has(request.session.get('user'), 'chores.override_complete') %}data-action="remove"{% endif %} />
            {% endif %}
        {% elif period.start <= now %}
            {% if completion %}
            <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" {% if completion.completed_by == request.session.get('user') or user_has(request.session.get('user'), 'chores.override_complete') %}data-action="remove"{% endif %} />
            {% elif user_has(request.session.get('user'), 'chores.complete_on_time') %}
            <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" data-action="add" />
            {% endif %}
        {% endif %}
        {% if completion %}
        <span class="completed-by">by {{ completion.completed_by }}</span>
        {% endif %}
    {% endif %}
</div>
<div class="description">{{ entry.description|markdown }}</div>
{% if can_edit %}
<form method="post" action="{{ request.url_for(is_skipped and 'unskip_instance' or 'skip_instance', entry_id=entry.id) }}">
    <input type="hidden" name="recurrence_index" value="{{ period.recurrence_index }}" />
    <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
    <button type="submit" class="skip-button">{{ 'Do not skip this instance' if is_skipped else 'Skip this instance' }}</button>
</form>
{% if not is_skipped %}
<h2>Delegation</h2>
{% if delegation %}
    <form id="delegation-update-form" method="post" action="{{ request.url_for('delegate_instance', entry_id=entry.id) }}">
        <input type="hidden" name="recurrence_index" value="{{ period.recurrence_index }}" />
        <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
    </form>
    <ul class="responsible-list delegation-responsible-list" id="delegation-responsible-list">
        {% for u in delegation.responsible %}
        <li data-user="{{ u }}">
            {{ u }}
            <button type="button" class="remove-user"><img src="{{ url_for('static', path='trash.svg') }}" alt="Remove" class="icon"></button>
        </li>
        {% endfor %}
    </ul>
    {% set ns = namespace(options=[]) %}
    {% for u in all_users() %}
        {% if u.username != 'Viewer' and u.username not in delegation.responsible %}
            {% set ns.options = ns.options + [u.username] %}
        {% endif %}
    {% endfor %}
    {% if ns.options %}
    <div class="responsible-selector">
        <button type="button" id="add-delegation-responsible" class="skip-button">Add</button>
        <div class="dropdown" id="delegation-dropdown">
            {% for name in ns.options %}
            <a href="#" data-user="{{ name }}">{{ name }}</a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    <form method="post" action="{{ request.url_for('remove_delegation', entry_id=entry.id) }}">
        <input type="hidden" name="recurrence_index" value="{{ period.recurrence_index }}" />
        <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
        <button type="submit" class="skip-button">Remove delegation</button>
    </form>
{% else %}
    <form method="post" action="{{ request.url_for('delegate_instance', entry_id=entry.id) }}">
        <input type="hidden" name="recurrence_index" value="{{ period.recurrence_index }}" />
        <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
        {% for u in responsible %}
        <input type="hidden" name="responsible[]" value="{{ u }}" />
        {% endfor %}
        <button type="submit" class="skip-button">Delegate this instance</button>
    </form>
{% endif %}
{% endif %}
{% endif %}
<script>
document.querySelectorAll('.checkbox-icon[data-action]').forEach(el => {
    el.addEventListener('click', async () => {
        const entry = el.dataset.entry;
        const r = parseInt(el.dataset.rindex);
        const i = parseInt(el.dataset.iindex);
        const url = el.dataset.action === 'add' ? `/calendar/${entry}/completion` : `/calendar/${entry}/completion/remove`;
        await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({recurrence_index: r, instance_index: i})
        });
        location.reload();
    });
});
document.addEventListener('DOMContentLoaded', function () {
    const list = document.getElementById('delegation-responsible-list');
    if (!list) return;
    const form = document.getElementById('delegation-update-form');
    const trashUrl = "{{ url_for('static', path='trash.svg') }}";
    function submitDelegation() {
        form.querySelectorAll('input[name="responsible[]"]').forEach(e => e.remove());
        list.querySelectorAll('li').forEach(li => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'responsible[]';
            input.value = li.dataset.user;
            form.appendChild(input);
        });
        fetch(form.action, { method: 'POST', credentials: 'same-origin', body: new FormData(form) }).then(() => location.reload());
    }
    list.addEventListener('click', e => {
        if (e.target.closest('.remove-user')) {
            e.preventDefault();
            e.target.closest('li').remove();
            submitDelegation();
        }
    });
    const addBtn = document.getElementById('add-delegation-responsible');
    const dropdown = document.getElementById('delegation-dropdown');
    if (addBtn) {
        addBtn.addEventListener('click', e => {
            e.stopPropagation();
            dropdown.classList.toggle('show');
        });
        dropdown.addEventListener('click', e => {
            const user = e.target.dataset.user;
            if (user) {
                e.preventDefault();
                const li = document.createElement('li');
                li.dataset.user = user;
                li.textContent = user;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'remove-user';
                btn.innerHTML = '<img src="' + trashUrl + '" alt="Remove" class="icon">';
                li.appendChild(btn);
                list.appendChild(li);
                dropdown.classList.remove('show');
                submitDelegation();
            }
        });
        document.addEventListener('click', e => {
            if (!dropdown.contains(e.target) && e.target !== addBtn) {
                dropdown.classList.remove('show');
            }
        });
    }
});
</script>
{% endblock %}
