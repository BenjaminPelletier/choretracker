{% extends "base.html" %}

{% block title %}{{ entry.title }} instance - Chore Tracker{% endblock %}

{% block content %}
<h1>
    {% if historical %}
    <img src="{{ url_for('static', path='historical.svg') }}" alt="Historical" class="icon historical-icon">
    {% endif %}
    <a href="{{ url_for('view_calendar_entry', entry_id=entry.id) }}">{{ entry.title }}</a> instance
</h1>
<p class="time-range">
    {% for user in responsible %}
    <img src="{{ url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
    {% endfor %}
    {% if entry.type == CalendarEntryType.Chore %}
        {% if period.end <= now %}
            {% if not completion and user_has(request.session.get('user'), 'chores.complete_overdue') %}
            <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rid="{{ period.recurrence_id }}" data-iindex="{{ period.instance_index }}" data-action="add" />
            {% elif completion %}
            <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rid="{{ period.recurrence_id }}" data-iindex="{{ period.instance_index }}" {% if completion.completed_by == request.session.get('user') or user_has(request.session.get('user'), 'chores.override_complete') %}data-action="remove"{% endif %} />
            {% endif %}
        {% elif period.start <= now %}
            {% if completion %}
            <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rid="{{ period.recurrence_id }}" data-iindex="{{ period.instance_index }}" {% if completion.completed_by == request.session.get('user') or user_has(request.session.get('user'), 'chores.override_complete') %}data-action="remove"{% endif %} />
            {% elif user_has(request.session.get('user'), 'chores.complete_on_time') %}
            <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rid="{{ period.recurrence_id }}" data-iindex="{{ period.instance_index }}" data-action="add" />
            {% endif %}
        {% endif %}
        {% if completion %}
        <span class="completed-by">by {{ completion.completed_by }}</span>
        {% endif %}
    {% endif %}
</p>
<p class="time-range">ðŸŸ¢ {{ period_start_display }}</p>
<p class="time-range">ðŸ›‘ {{ period_end_display }}</p>
<div class="description">{{ entry.description|markdown|safe }}</div>
{% if can_edit %}
<form method="post" action="{{ url_for(is_skipped and 'unskip_instance' or 'skip_instance', entry_id=entry.id) }}">
    <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
    <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
    <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
    <button type="submit" class="skip-button">{{ 'Do not skip this instance' if is_skipped else 'Skip this instance' }}</button>
</form>
{% endif %}
{% if can_edit %}
<div class="duration-section">
    <h2>
        Duration
        {% if duration_override %}
            <button type="button" id="edit-duration" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
            <form method="post" action="{{ url_for('remove_instance_duration', entry_id=entry.id) }}" style="display:inline" id="delete-duration-form">
                <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
                <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
                <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
                <button type="submit" class="icon-button"><img src="{{ url_for('static', path='trash.svg') }}" alt="Delete" class="icon"></button>
            </form>
        {% else %}
            <button type="button" id="add-duration" class="icon-button"><img src="{{ url_for('static', path='plus.svg') }}" alt="Add" class="icon"></button>
        {% endif %}
    </h2>
    {% if duration_override %}
    <div id="duration-display" class="duration-display" data-duration-seconds="{{ duration_override.total_seconds()|int }}">{{ duration_override|format_duration }}</div>
    {% endif %}
    <form method="post" action="{{ url_for('set_instance_duration', entry_id=entry.id) }}" id="duration-editor" style="display:none">
        <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
        <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
        <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
        <div class="duration-inputs">
            <button type="button" id="toggle-duration-mode" class="icon-button">
                <img id="duration-mode-icon" src="{{ url_for('static', path='endtime.svg') }}" alt="Use end time" class="icon">
            </button>
            <span id="duration-fields">
                <input type="number" class="inline-input" name="duration_days" placeholder="Days" min="0">
                <input type="number" class="inline-input" name="duration_hours" placeholder="Hours" min="0">
                <input type="number" class="inline-input" name="duration_minutes" placeholder="Minutes" min="0" max="59">
            </span>
            <input type="datetime-local" name="end_time" id="end_time" class="inline-input" style="display:none">
        </div>
        <div>
            <button type="submit" class="icon-button"><img src="{{ url_for('static', path='disk.svg') }}" alt="Save" class="icon"></button>
            <button type="button" id="cancel-duration" class="icon-button"><img src="{{ url_for('static', path='x.svg') }}" alt="Cancel" class="icon"></button>
        </div>
    </form>
</div>
{% endif %}
{% if can_edit or note %}
<div class="additional-notes-section">
    <h2>
        Additional notes
        {% if note %}
            {% if can_edit %}
            <button type="button" id="edit-note" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
            <form method="post" action="{{ url_for('remove_instance_note', entry_id=entry.id) }}" style="display:inline" id="delete-note-form">
                <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
                <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
                <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
                <button type="submit" class="icon-button"><img src="{{ url_for('static', path='trash.svg') }}" alt="Delete" class="icon"></button>
            </form>
            {% endif %}
        {% elif can_edit %}
            <button type="button" id="add-note" class="icon-button"><img src="{{ url_for('static', path='plus.svg') }}" alt="Add" class="icon"></button>
        {% endif %}
    </h2>
    {% if note %}
    <div id="note-display" class="additional-notes">{{ note|markdown|safe }}</div>
    {% endif %}
    {% if can_edit %}
    <form method="post" action="{{ url_for('add_instance_note', entry_id=entry.id) }}" id="note-editor" style="display:none">
        <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
        <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
        <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
        <textarea name="note" rows="4" cols="40">{{ note or '' }}</textarea>
        <div>
            <button type="submit" class="icon-button"><img src="{{ url_for('static', path='disk.svg') }}" alt="Save" class="icon"></button>
            <button type="button" id="cancel-note" class="icon-button"><img src="{{ url_for('static', path='x.svg') }}" alt="Cancel" class="icon"></button>
        </div>
    </form>
    {% endif %}
</div>
{% endif %}
{% if can_edit and not is_skipped %}
<h2>
    Delegation
    {% if delegation and can_edit %}
    <button type="button" id="edit-delegation" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
    <form method="post" action="{{ url_for('remove_delegation', entry_id=entry.id) }}" style="display:inline">
        <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
        <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
        <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
        <button type="submit" class="icon-button"><img src="{{ url_for('static', path='trash.svg') }}" alt="Delete" class="icon"></button>
    </form>
    {% elif can_edit %}
    <button type="button" id="delegate-this-instance" class="icon-button"><img src="{{ url_for('static', path='plus.svg') }}" alt="Add" class="icon"></button>
    {% endif %}
</h2>
{% if delegation %}
<ul class="responsible-list" id="delegation-display-list">
    {% for u in delegation.responsible %}
    <li data-user="{{ u }}">{{ u }}</li>
    {% endfor %}
</ul>
{% endif %}
{% if can_edit %}
<div id="delegation-editor" style="display:none"></div>
{% endif %}
{% endif %}
<script>
document.querySelectorAll('.checkbox-icon[data-action]').forEach(el => {
    el.addEventListener('click', async () => {
        const entry = el.dataset.entry;
        const r = parseInt(el.dataset.rid);
        const i = parseInt(el.dataset.iindex);
        const url = el.dataset.action === 'add' ? `/calendar/${entry}/completion` : `/calendar/${entry}/completion/remove`;
        await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({recurrence_id: r, instance_index: i})
        });
        location.reload();
    });
});
document.addEventListener('DOMContentLoaded', () => {
    const entryId = {{ entry.id }};
    const rid = {{ period.recurrence_id }};
    const iindex = {{ period.instance_index }};
    const csrfToken = {{ request.session.get('csrf_token', '')|tojson }};
    const allUsers = {{ all_users()|selectattr('username','ne','Viewer')|map(attribute='username')|list|tojson }};
    const diskUrl = "{{ url_for('static', path='disk.svg') }}";
    const xUrl = "{{ url_for('static', path='x.svg') }}";
    const plusUrl = "{{ url_for('static', path='plus.svg') }}";
    const trashUrl = "{{ url_for('static', path='trash.svg') }}";
    const endtimeUrl = "{{ url_for('static', path='endtime.svg') }}";
    const durationUrl = "{{ url_for('static', path='duration.svg') }}";
    const noteExists = {{ 'true' if note else 'false' }};
    const addNoteBtn = document.getElementById('add-note');
    const editNoteBtn = document.getElementById('edit-note');
    const deleteNoteForm = document.getElementById('delete-note-form');
    const noteEditor = document.getElementById('note-editor');
    const noteDisplay = document.getElementById('note-display');
    const cancelNoteBtn = document.getElementById('cancel-note');

    const durationExists = {{ 'true' if duration_override else 'false' }};
    const defaultDurationSeconds = {{ base_duration.total_seconds()|int if base_duration else 0 }};
    const addDurationBtn = document.getElementById('add-duration');
    const editDurationBtn = document.getElementById('edit-duration');
    const deleteDurationForm = document.getElementById('delete-duration-form');
    const durationEditor = document.getElementById('duration-editor');
    const durationDisplay = document.getElementById('duration-display');
    const cancelDurationBtn = document.getElementById('cancel-duration');

    function openNoteEditor() {
        if (noteEditor) noteEditor.style.display = 'block';
        if (noteDisplay) noteDisplay.style.display = 'none';
        if (addNoteBtn) addNoteBtn.style.display = 'none';
        if (editNoteBtn) editNoteBtn.style.display = 'none';
        if (deleteNoteForm) deleteNoteForm.style.display = 'none';
    }
    if (addNoteBtn) addNoteBtn.addEventListener('click', openNoteEditor);
    if (editNoteBtn) editNoteBtn.addEventListener('click', openNoteEditor);
    if (cancelNoteBtn) cancelNoteBtn.addEventListener('click', () => {
        if (noteEditor) noteEditor.style.display = 'none';
        if (noteDisplay) noteDisplay.style.display = '';
        if (noteExists) {
            if (editNoteBtn) editNoteBtn.style.display = '';
            if (deleteNoteForm) deleteNoteForm.style.display = 'inline';
        } else if (addNoteBtn) {
            addNoteBtn.style.display = '';
        }
    });

    if (durationEditor) {
    const toggleMode = document.getElementById('toggle-duration-mode');
    const modeIcon = document.getElementById('duration-mode-icon');
    const durationFields = document.getElementById('duration-fields');
    const endTimeInput = document.getElementById('end_time');
    const dayInput = durationEditor.querySelector('input[name="duration_days"]');
    const hourInput = durationEditor.querySelector('input[name="duration_hours"]');
    const minuteInput = durationEditor.querySelector('input[name="duration_minutes"]');
    let useEndTime = false;
    const periodStart = new Date("{{ period.start.strftime('%Y-%m-%dT%H:%M') }}");

    function updateEndFromInputs() {
        const d = parseInt(dayInput.value || '0');
        const h = parseInt(hourInput.value || '0');
        const m = parseInt(minuteInput.value || '0');
        const end = new Date(periodStart.getTime() + (d * 86400 + h * 3600 + m * 60) * 1000);
        const local = new Date(end.getTime() - end.getTimezoneOffset() * 60000)
            .toISOString()
            .slice(0, 16);
        endTimeInput.value = local;
    }
    function updateInputsFromEnd() {
        const end = new Date(endTimeInput.value);
        const diff = end - periodStart;
        const d = Math.floor(diff / 86400000);
        const h = Math.floor((diff % 86400000) / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        dayInput.value = d || '';
        hourInput.value = h || '';
        minuteInput.value = m || '';
    }
    toggleMode.addEventListener('click', () => {
        useEndTime = !useEndTime;
        if (useEndTime) {
            modeIcon.src = durationUrl;
            durationFields.style.display = 'none';
            endTimeInput.style.display = '';
            updateEndFromInputs();
        } else {
            modeIcon.src = endtimeUrl;
            durationFields.style.display = '';
            endTimeInput.style.display = 'none';
            updateInputsFromEnd();
        }
    });

    function openDurationEditor(initial) {
        if (durationEditor) durationEditor.style.display = 'block';
        if (durationDisplay) durationDisplay.style.display = 'none';
        if (addDurationBtn) addDurationBtn.style.display = 'none';
        if (editDurationBtn) editDurationBtn.style.display = 'none';
        if (deleteDurationForm) deleteDurationForm.style.display = 'none';
        const days = Math.floor(initial / 86400);
        const hours = Math.floor((initial % 86400) / 3600);
        const minutes = Math.floor((initial % 3600) / 60);
        dayInput.value = days || '';
        hourInput.value = hours || '';
        minuteInput.value = minutes || '';
        updateEndFromInputs();
        useEndTime = false;
        modeIcon.src = endtimeUrl;
        durationFields.style.display = '';
        endTimeInput.style.display = 'none';
    }
    if (addDurationBtn) addDurationBtn.addEventListener('click', () => openDurationEditor(defaultDurationSeconds));
    if (editDurationBtn) editDurationBtn.addEventListener('click', () => {
        const secs = parseInt(durationDisplay.dataset.durationSeconds || '0');
        openDurationEditor(secs);
    });
    if (cancelDurationBtn) cancelDurationBtn.addEventListener('click', () => {
        if (durationEditor) durationEditor.style.display = 'none';
        if (durationDisplay) durationDisplay.style.display = '';
        if (durationExists) {
            if (editDurationBtn) editDurationBtn.style.display = '';
            if (deleteDurationForm) deleteDurationForm.style.display = 'inline';
        } else if (addDurationBtn) {
            addDurationBtn.style.display = '';
        }
    });
    durationEditor.addEventListener('submit', e => {
        if (useEndTime) {
            const diff = new Date(endTimeInput.value) - periodStart;
            if (diff <= 0) {
                e.preventDefault();
                alert('End time must be after start time');
                return;
            }
            updateInputsFromEnd();
        }
    });
    }

    function makeBtn(url, alt) {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'icon-button';
        const img = document.createElement('img');
        img.src = url;
        img.alt = alt;
        img.className = 'icon';
        b.appendChild(img);
        return b;
    }

    function startDelegationEdit(initial) {
        const editor = document.getElementById('delegation-editor');
        editor.innerHTML = '';
        editor.style.display = 'block';
        const display = document.getElementById('delegation-display-list');
        if (display) display.style.display = 'none';
        const button = document.getElementById('delegate-this-instance');
        if (button) button.style.display = 'none';

        const list = document.createElement('ul');
        list.className = 'responsible-list';
        editor.appendChild(list);

        const addWrap = document.createElement('span');
        addWrap.className = 'responsible-selector';
        const addBtn = makeBtn(plusUrl, 'Add user');
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown';
        dropdown.style.display = 'none';
        addWrap.appendChild(addBtn);
        addWrap.appendChild(dropdown);
        editor.appendChild(addWrap);

        const delegates = [...initial];

        function refreshList() {
            list.innerHTML = '';
            delegates.forEach(u => {
                const li = document.createElement('li');
                li.textContent = u;
                const rm = makeBtn(trashUrl, 'Remove');
                rm.addEventListener('click', () => {
                    const idx = delegates.indexOf(u);
                    if (idx >= 0) delegates.splice(idx, 1);
                    refreshList();
                    refreshDropdown();
                });
                li.appendChild(rm);
                list.appendChild(li);
            });
        }

        function refreshDropdown() {
            dropdown.innerHTML = '';
            allUsers.filter(u => !delegates.includes(u)).forEach(u => {
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = u;
                a.addEventListener('click', e => {
                    e.preventDefault();
                    delegates.push(u);
                    refreshList();
                    dropdown.style.display = 'none';
                    refreshDropdown();
                });
                dropdown.appendChild(a);
            });
        }

        addBtn.addEventListener('click', e => {
            e.stopPropagation();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', e => {
            if (!dropdown.contains(e.target) && e.target !== addBtn) {
                dropdown.style.display = 'none';
            }
        });

        const save = makeBtn(diskUrl, 'Save');
        const cancel = makeBtn(xUrl, 'Cancel');
        editor.appendChild(save);
        editor.appendChild(cancel);

        refreshList();
        refreshDropdown();

        save.addEventListener('click', () => {
            if (delegates.length === 0) {
                alert('Delegation must include at least one user');
                return;
            }
            const form = new FormData();
            form.append('recurrence_id', rid);
            form.append('instance_index', iindex);
            form.append('csrf_token', csrfToken);
            delegates.forEach(u => form.append('responsible[]', u));
            fetch(`/calendar/${entryId}/delegation`, { method: 'POST', credentials: 'same-origin', body: form }).then(resp => {
                if (resp.ok) {
                    location.reload();
                } else {
                    alert('Failed to save delegation');
                }
            });
        });
        cancel.addEventListener('click', () => location.reload());
    }

    const delegateBtn = document.getElementById('delegate-this-instance');
    if (delegateBtn) delegateBtn.addEventListener('click', () => startDelegationEdit([]));

    const editBtn = document.getElementById('edit-delegation');
    if (editBtn) editBtn.addEventListener('click', () => {
        const current = Array.from(document.querySelectorAll('#delegation-display-list li')).map(li => li.dataset.user || li.textContent.trim());
        startDelegationEdit(current);
    });
});
</script>
{% endblock %}
