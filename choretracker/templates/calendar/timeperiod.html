{% extends "base.html" %}

{% block title %}{{ entry.title }} - Chore Tracker{% endblock %}

{% block content %}
<h1><a href="{{ request.url_for('view_calendar_entry', entry_id=entry.id) }}">{{ entry.title }}</a></h1>
<div class="time-range">
    <span>{{ period|format_time_range }}</span>
    {% if entry.type == CalendarEntryType.Chore %}
        {% if period.end <= now %}
            {% if not completion and user_has(request.session.get('user'), 'chores.complete_overdue') %}
            <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" data-action="add" />
            {% elif completion %}
            <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" {% if completion.completed_by == request.session.get('user') or user_has(request.session.get('user'), 'chores.override_complete') %}data-action="remove"{% endif %} />
            {% endif %}
        {% elif period.start <= now %}
            {% if completion %}
            <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" {% if completion.completed_by == request.session.get('user') or user_has(request.session.get('user'), 'chores.override_complete') %}data-action="remove"{% endif %} />
            {% elif user_has(request.session.get('user'), 'chores.complete_on_time') %}
            <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" data-action="add" />
            {% endif %}
        {% endif %}
        {% if completion %}
        <span class="completed-by">by {{ completion.completed_by }}</span>
        {% endif %}
    {% endif %}
</div>
<p>{{ entry.description }}</p>
{% if can_edit and period.recurrence_index >= 0 %}
<form method="post" action="{{ request.url_for(is_skipped and 'unskip_instance' or 'skip_instance', entry_id=entry.id) }}">
    <input type="hidden" name="recurrence_index" value="{{ period.recurrence_index }}" />
    <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
    <button type="submit">{{ 'Do not skip this instance' if is_skipped else 'Skip this instance' }}</button>
</form>
{% endif %}
<script>
document.querySelectorAll('.checkbox-icon[data-action]').forEach(el => {
    el.addEventListener('click', async () => {
        const entry = el.dataset.entry;
        const r = parseInt(el.dataset.rindex);
        const i = parseInt(el.dataset.iindex);
        const url = el.dataset.action === 'add' ? `/calendar/${entry}/completion` : `/calendar/${entry}/completion/remove`;
        await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({recurrence_index: r, instance_index: i})
        });
        location.reload();
    });
});
</script>
{% endblock %}
