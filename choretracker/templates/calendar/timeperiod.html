{% extends "base.html" %}

{% block title %}{{ entry.title }} instance - Chore Tracker{% endblock %}

{% block content %}
<h1>
    {% if historical %}
    <img src="{{ url_for('static', path='historical.svg') }}" alt="Historical" class="icon historical-icon">
    {% endif %}
    <a href="{{ url_for('view_calendar_entry', entry_id=entry.id) }}">{{ entry.title }}</a> instance
</h1>
<p class="time-range responsible-line">
    {% for user in responsible %}
    <span class="responsible-item">
        <img src="{{ url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
        {% if delegation and delegation.responsible and can_edit and not is_skipped %}
        <button type="button" class="icon-button remove-resp" data-user="{{ user }}"><img src="{{ url_for('static', path='trash.svg') }}" alt="Remove" class="icon"></button>
        {% endif %}
    </span>
    {% endfor %}
    {% if can_edit and not is_skipped %}
    <span class="responsible-selector" id="add-resp-wrap">
        <button type="button" id="add-resp-btn" class="icon-button"><img src="{{ url_for('static', path='plus.svg') }}" alt="Add" class="icon"></button>
        <div class="dropdown" id="add-resp-dropdown" style="display:none; position:absolute; left:0; right:auto; top:100%"></div>
    </span>
    {% endif %}
    {% if entry.type == CalendarEntryType.Chore %}
        {% if period.end <= now %}
            {% if not completion and user_has(request.session.get('user'), 'chores.complete_overdue') %}
            <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rid="{{ period.recurrence_id }}" data-iindex="{{ period.instance_index }}" data-action="add" />
            {% elif completion %}
            <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rid="{{ period.recurrence_id }}" data-iindex="{{ period.instance_index }}" {% if completion.completed_by == request.session.get('user') or user_has(request.session.get('user'), 'chores.override_complete') %}data-action="remove"{% endif %} />
            {% endif %}
        {% elif period.start <= now %}
            {% if completion %}
            <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rid="{{ period.recurrence_id }}" data-iindex="{{ period.instance_index }}" {% if completion.completed_by == request.session.get('user') or user_has(request.session.get('user'), 'chores.override_complete') %}data-action="remove"{% endif %} />
            {% elif user_has(request.session.get('user'), 'chores.complete_on_time') %}
            <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rid="{{ period.recurrence_id }}" data-iindex="{{ period.instance_index }}" data-action="add" />
            {% endif %}
        {% endif %}
        {% if completion %}
        <span class="completed-by">by {{ completion.completed_by }}</span>
        {% endif %}
    {% endif %}
</p>
<div class="time-range" id="start-display-line">
    ðŸŸ¢ <span id="start-display">{{ period_start_display }}</span>
    {% if can_edit_start %}
        {% if start_override and can_remove_start %}
        <form method="post" action="{{ url_for('remove_instance_start', entry_id=entry.id) }}" style="display:inline" class="delete-start-form">
            <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
            <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
            <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
            <button type="submit" class="icon-button"><img src="{{ url_for('static', path='trash.svg') }}" alt="Delete" class="icon"></button>
        </form>
        {% endif %}
        <button type="button" id="edit-start" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
    {% endif %}
</div>
<div class="time-range" id="start-editor" style="display:none">
    ðŸŸ¢
    <form method="post" action="{{ url_for('set_instance_start', entry_id=entry.id) }}" style="display:inline" id="start-edit-form">
        <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
        <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
        <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
        <input type="datetime-local" name="start_time" id="start-input" value="{{ period.start.strftime('%Y-%m-%dT%H:%M') }}" class="inline-input">
        <button type="submit" class="icon-button"><img src="{{ url_for('static', path='disk.svg') }}" alt="Save" class="icon"></button>
    </form>
    {% if start_override and can_remove_start %}
    <form method="post" action="{{ url_for('remove_instance_start', entry_id=entry.id) }}" style="display:inline" class="delete-start-form">
        <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
        <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
        <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
        <button type="submit" class="icon-button"><img src="{{ url_for('static', path='trash.svg') }}" alt="Delete" class="icon"></button>
    </form>
    {% endif %}
    <button type="button" id="cancel-start" class="icon-button"><img src="{{ url_for('static', path='x.svg') }}" alt="Cancel" class="icon"></button>
</div>
<div class="time-range" id="end-display-line">
    ðŸ›‘ <span id="end-display">{{ period_end_display }}</span>
    {% if can_edit %}
        {% if duration_override %}
        <form method="post" action="{{ url_for('remove_instance_duration', entry_id=entry.id) }}" style="display:inline" id="delete-duration-form">
            <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
            <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
            <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
            <button type="submit" class="icon-button"><img src="{{ url_for('static', path='trash.svg') }}" alt="Delete" class="icon"></button>
        </form>
        {% endif %}
        <button type="button" id="edit-duration" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
    {% endif %}
</div>
<div class="time-range" id="end-editor" style="display:none">
    ðŸ›‘
    <form method="post" action="{{ url_for('set_instance_duration', entry_id=entry.id) }}" id="duration-edit-form" style="display:inline">
        <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
        <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
        <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
        <span class="duration-inputs">
            <button type="button" id="toggle-duration-mode" class="icon-button">
                <img id="duration-mode-icon" src="{{ url_for('static', path='endtime.svg') }}" alt="Use end time" class="icon">
            </button>
            <span id="duration-fields">
                <label><input type="number" class="inline-input" name="duration_days" placeholder="Days" min="0">d</label>
                <label><input type="number" class="inline-input" name="duration_hours" placeholder="Hours" min="0">h</label>
                <label><input type="number" class="inline-input" name="duration_minutes" placeholder="Minutes" min="0" max="59">m</label>
            </span>
            <input type="datetime-local" name="end_time" id="end_time" class="inline-input" style="display:none">
        </span>
        {% if duration_override %}
        <button type="submit" formaction="{{ url_for('remove_instance_duration', entry_id=entry.id) }}" class="icon-button"><img src="{{ url_for('static', path='trash.svg') }}" alt="Delete" class="icon"></button>
        {% endif %}
        <button type="submit" class="icon-button"><img src="{{ url_for('static', path='disk.svg') }}" alt="Save" class="icon"></button>
        <button type="button" id="cancel-duration" class="icon-button"><img src="{{ url_for('static', path='x.svg') }}" alt="Cancel" class="icon"></button>
    </form>
</div>
<div class="description">{{ entry.description|markdown|safe }}</div>
{% if can_edit %}
<form method="post" action="{{ url_for(is_skipped and 'unskip_instance' or 'skip_instance', entry_id=entry.id) }}">
    <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
    <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
    <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
    <button type="submit" class="skip-button">{{ 'Do not skip this instance' if is_skipped else 'Skip this instance' }}</button>
</form>
{% endif %}
{% if can_edit or note %}
<div class="additional-notes-section">
    <h2>
        Additional notes
        {% if note %}
            {% if can_edit %}
            <button type="button" id="edit-note" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
            <form method="post" action="{{ url_for('remove_instance_note', entry_id=entry.id) }}" style="display:inline" id="delete-note-form">
                <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
                <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
                <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
                <button type="submit" class="icon-button"><img src="{{ url_for('static', path='trash.svg') }}" alt="Delete" class="icon"></button>
            </form>
            {% endif %}
        {% elif can_edit %}
            <button type="button" id="add-note" class="icon-button"><img src="{{ url_for('static', path='plus.svg') }}" alt="Add" class="icon"></button>
        {% endif %}
    </h2>
    {% if note %}
    <div id="note-display" class="additional-notes">{{ note|markdown|safe }}</div>
    {% endif %}
    {% if can_edit %}
    <form method="post" action="{{ url_for('add_instance_note', entry_id=entry.id) }}" id="note-editor" style="display:none">
        <input type="hidden" name="recurrence_id" value="{{ period.recurrence_id }}" />
        <input type="hidden" name="instance_index" value="{{ period.instance_index }}" />
        <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}" />
        <textarea name="note" rows="4" cols="40">{{ note or '' }}</textarea>
        <div>
            <button type="submit" class="icon-button"><img src="{{ url_for('static', path='disk.svg') }}" alt="Save" class="icon"></button>
            <button type="button" id="cancel-note" class="icon-button"><img src="{{ url_for('static', path='x.svg') }}" alt="Cancel" class="icon"></button>
        </div>
    </form>
    {% endif %}
</div>
{% endif %}
<script>
document.querySelectorAll('.checkbox-icon[data-action]').forEach(el => {
    el.addEventListener('click', async () => {
        const entry = el.dataset.entry;
        const r = parseInt(el.dataset.rid);
        const i = parseInt(el.dataset.iindex);
        const url = el.dataset.action === 'add' ? `/calendar/${entry}/completion` : `/calendar/${entry}/completion/remove`;
        await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({recurrence_id: r, instance_index: i})
        });
        location.reload();
    });
});
document.addEventListener('DOMContentLoaded', () => {
    const entryId = {{ entry.id }};
    const rid = {{ period.recurrence_id }};
    const iindex = {{ period.instance_index }};
    const csrfToken = {{ request.session.get('csrf_token', '')|tojson }};
    const allUsers = {{ all_users()|selectattr('username','ne','Viewer')|map(attribute='username')|list|tojson }};
    const endtimeUrl = "{{ url_for('static', path='endtime.svg') }}";
    const durationUrl = "{{ url_for('static', path='duration.svg') }}";
    const noteExists = {{ 'true' if note else 'false' }};
    const addNoteBtn = document.getElementById('add-note');
    const editNoteBtn = document.getElementById('edit-note');
    const deleteNoteForm = document.getElementById('delete-note-form');
    const noteEditor = document.getElementById('note-editor');
    const noteDisplay = document.getElementById('note-display');
    const cancelNoteBtn = document.getElementById('cancel-note');

    const durationExists = {{ 'true' if duration_override else 'false' }};
    const currentDurationSeconds = {{ duration_override.total_seconds()|int if duration_override else 0 }};
    const defaultDurationSeconds = {{ base_duration.total_seconds()|int if base_duration else 0 }};
    const editDurationBtn = document.getElementById('edit-duration');
    const endDisplayLine = document.getElementById('end-display-line');
    const endEditor = document.getElementById('end-editor');
    const durationEditForm = document.getElementById('duration-edit-form');
    const cancelDurationBtn = document.getElementById('cancel-duration');

    const editStartBtn = document.getElementById('edit-start');
    const startDisplayLine = document.getElementById('start-display-line');
    const startEditor = document.getElementById('start-editor');
    const cancelStartBtn = document.getElementById('cancel-start');

    function openNoteEditor() {
        if (noteEditor) noteEditor.style.display = 'block';
        if (noteDisplay) noteDisplay.style.display = 'none';
        if (addNoteBtn) addNoteBtn.style.display = 'none';
        if (editNoteBtn) editNoteBtn.style.display = 'none';
        if (deleteNoteForm) deleteNoteForm.style.display = 'none';
    }
    if (addNoteBtn) addNoteBtn.addEventListener('click', openNoteEditor);
    if (editNoteBtn) editNoteBtn.addEventListener('click', openNoteEditor);
    if (cancelNoteBtn) cancelNoteBtn.addEventListener('click', () => {
        if (noteEditor) noteEditor.style.display = 'none';
        if (noteDisplay) noteDisplay.style.display = '';
        if (noteExists) {
            if (editNoteBtn) editNoteBtn.style.display = '';
            if (deleteNoteForm) deleteNoteForm.style.display = 'inline';
        } else if (addNoteBtn) {
            addNoteBtn.style.display = '';
        }
    });

    const initialDelegates = {{ delegation.responsible|tojson if delegation and delegation.responsible else [] }};
    const addRespWrap = document.getElementById('add-resp-wrap');
    if (addRespWrap) {
        let delegates = [...initialDelegates];
        const addBtn = document.getElementById('add-resp-btn');
        const dropdown = document.getElementById('add-resp-dropdown');

        function sendDelegates() {
            if (delegates.length === 0) {
                const form = new FormData();
                form.append('recurrence_id', rid);
                form.append('instance_index', iindex);
                form.append('csrf_token', csrfToken);
                fetch(`/calendar/${entryId}/delegation/remove`, { method: 'POST', credentials: 'same-origin', body: form }).then(() => location.reload());
            } else {
                const form = new FormData();
                form.append('recurrence_id', rid);
                form.append('instance_index', iindex);
                form.append('csrf_token', csrfToken);
                delegates.forEach(u => form.append('responsible[]', u));
                fetch(`/calendar/${entryId}/delegation`, { method: 'POST', credentials: 'same-origin', body: form }).then(() => location.reload());
            }
        }

        function refreshDropdown() {
            dropdown.innerHTML = '';
            const available = allUsers.filter(u => !delegates.includes(u));
            if (available.length === 0) {
                addRespWrap.style.display = 'none';
                dropdown.style.display = 'none';
            } else {
                addRespWrap.style.display = '';
                available.forEach(u => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = u;
                    a.addEventListener('click', e => {
                        e.preventDefault();
                        delegates.push(u);
                        sendDelegates();
                    });
                    dropdown.appendChild(a);
                });
            }
        }

        document.querySelectorAll('.remove-resp').forEach(btn => {
            btn.addEventListener('click', () => {
                const user = btn.dataset.user;
                const idx = delegates.indexOf(user);
                if (idx >= 0) delegates.splice(idx, 1);
                sendDelegates();
            });
        });

        addBtn.addEventListener('click', e => {
            e.stopPropagation();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', e => {
            if (!dropdown.contains(e.target) && e.target !== addBtn) dropdown.style.display = 'none';
        });

        refreshDropdown();
    }

    if (editStartBtn) {
        editStartBtn.addEventListener('click', () => {
            if (startDisplayLine) startDisplayLine.style.display = 'none';
            if (startEditor) startEditor.style.display = '';
        });
    }
    if (cancelStartBtn) {
        cancelStartBtn.addEventListener('click', () => {
            if (startEditor) startEditor.style.display = 'none';
            if (startDisplayLine) startDisplayLine.style.display = '';
        });
    }

    const startEditForm = document.getElementById('start-edit-form');
    if (startEditForm) {
        startEditForm.addEventListener('submit', e => {
            e.preventDefault();
            fetch(startEditForm.action, {
                method: 'POST',
                body: new FormData(startEditForm),
                credentials: 'same-origin'
            }).then(async resp => {
                if (resp.ok) {
                    location.reload();
                } else {
                    const ct = resp.headers.get('content-type') || '';
                    let msg;
                    if (ct.includes('application/json')) {
                        try {
                            const data = await resp.json();
                            msg = data.detail || JSON.stringify(data);
                        } catch {
                            msg = await resp.text();
                        }
                    } else {
                        msg = await resp.text();
                    }
                    alert(msg);
                }
            });
        });
    }

    if (durationEditForm) {
    const toggleMode = document.getElementById('toggle-duration-mode');
    const modeIcon = document.getElementById('duration-mode-icon');
    const durationFields = document.getElementById('duration-fields');
    const endTimeInput = document.getElementById('end_time');
    const dayInput = durationEditForm.querySelector('input[name="duration_days"]');
    const hourInput = durationEditForm.querySelector('input[name="duration_hours"]');
    const minuteInput = durationEditForm.querySelector('input[name="duration_minutes"]');
    let useEndTime = false;
    const periodStart = new Date("{{ period.start.strftime('%Y-%m-%dT%H:%M') }}");

    function updateEndFromInputs() {
        const d = parseInt(dayInput.value || '0');
        const h = parseInt(hourInput.value || '0');
        const m = parseInt(minuteInput.value || '0');
        const end = new Date(periodStart.getTime() + (d * 86400 + h * 3600 + m * 60) * 1000);
        const local = new Date(end.getTime() - end.getTimezoneOffset() * 60000)
            .toISOString()
            .slice(0, 16);
        endTimeInput.value = local;
    }
    function updateInputsFromEnd() {
        const end = new Date(endTimeInput.value);
        const diff = end - periodStart;
        const d = Math.floor(diff / 86400000);
        const h = Math.floor((diff % 86400000) / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        dayInput.value = d || '';
        hourInput.value = h || '';
        minuteInput.value = m || '';
    }
    toggleMode.addEventListener('click', () => {
        useEndTime = !useEndTime;
        if (useEndTime) {
            modeIcon.src = durationUrl;
            durationFields.style.display = 'none';
            endTimeInput.style.display = '';
            updateEndFromInputs();
        } else {
            modeIcon.src = endtimeUrl;
            durationFields.style.display = '';
            endTimeInput.style.display = 'none';
            updateInputsFromEnd();
        }
    });

    function openDurationEditor(initial) {
        if (endDisplayLine) endDisplayLine.style.display = 'none';
        if (endEditor) endEditor.style.display = 'block';
        const days = Math.floor(initial / 86400);
        const hours = Math.floor((initial % 86400) / 3600);
        const minutes = Math.floor((initial % 3600) / 60);
        dayInput.value = days || '';
        hourInput.value = hours || '';
        minuteInput.value = minutes || '';
        updateEndFromInputs();
        useEndTime = false;
        modeIcon.src = endtimeUrl;
        durationFields.style.display = '';
        endTimeInput.style.display = 'none';
    }
    if (editDurationBtn) editDurationBtn.addEventListener('click', () => {
        const secs = durationExists ? currentDurationSeconds : defaultDurationSeconds;
        openDurationEditor(secs);
    });
    if (cancelDurationBtn) cancelDurationBtn.addEventListener('click', () => {
        if (endEditor) endEditor.style.display = 'none';
        if (endDisplayLine) endDisplayLine.style.display = '';
    });
    durationEditForm.addEventListener('submit', e => {
        if (useEndTime) {
            const diff = new Date(endTimeInput.value) - periodStart;
            if (diff <= 0) {
                e.preventDefault();
                alert('End time must be after start time');
                return;
            }
            updateInputsFromEnd();
        }
    });
    }

});
</script>
{% endblock %}
