{% extends "base.html" %}

{% block title %}{% if entry %}Edit{% else %}New{% endif %} {{ entry_type }} - Chore Tracker{% endblock %}

{% block content %}
<h1>{% if entry %}Edit{% else %}New{% endif %} {{ entry_type }}</h1>
<form id="entry-form" class="form" method="post" action="{% if entry %}{{ url_for('update_calendar_entry', entry_id=entry.id) }}{% else %}/calendar/new{% endif %}">
    <input type="hidden" name="type" value="{{ entry_type }}">

    <div class="field">
        <div class="label-row">
            <label for="title">Title<span class="required">*</span></label>
            <span class="help" data-help="Short name for this entry">?</span>
        </div>
        <input type="text" id="title" name="title" required>
    </div>

    <div class="field">
        <div class="label-row">
            <label for="description">Description</label>
            <span class="help" data-help="More details about this entry">?</span>
        </div>
        <textarea id="description" name="description" rows="3"></textarea>
    </div>

    <div class="field">
        <div class="label-row">
            <label for="first_start">First start<span class="required">*</span></label>
            <span class="help" data-help="Start time of the first instance">?</span>
        </div>
        <input type="datetime-local" id="first_start" name="first_start" required>
    </div>

    <div class="field">
        <div class="label-row">
            <span>Duration<span class="required">*</span></span>
            <span class="help" data-help="Length of each instance">?</span>
        </div>
        <div class="duration-inputs">
            <input type="number" name="duration_days" placeholder="Days" min="0">
            <input type="number" name="duration_hours" placeholder="Hours" min="0">
            <input type="number" name="duration_minutes" placeholder="Minutes" min="0" max="59">
        </div>
    </div>

    <div class="field">
        <div class="label-row">
            <span>Recurrences</span>
            <span class="help" data-help="Schedules on which this repeats">?</span>
            <button type="button" id="add-recurrence" class="icon-button">
                <img src="{{ url_for('static', path='plus.svg') }}" alt="Add recurrence" class="icon">
            </button>
        </div>
        <div id="recurrences"></div>
    </div>

    <div class="field">
        <div class="label-row">
            <label for="none_after">None after</label>
            <span class="help" data-help="No instances start after this time">?</span>
        </div>
        <input type="datetime-local" id="none_after" name="none_after">
    </div>

    <div class="field">
        <div class="label-row">
            <span>Managers</span>
            <span class="help" data-help="People who can edit this entry">?</span>
        </div>
        <div class="responsible-selector">
            <button type="button" id="add-managers">Add</button>
            <div class="dropdown" id="managers-dropdown">
                {% for u in all_users() %}
                <a href="#" data-user="{{ u.username }}">{{ u.username }}</a>
                {% endfor %}
            </div>
        </div>
        <ul id="managers-list"></ul>
    </div>

    <div class="field">
        <div class="label-row">
            <span>Responsible</span>
            <span class="help" data-help="People responsible for this entry">?</span>
        </div>
        <div class="responsible-selector">
            <button type="button" id="add-responsible">Add</button>
            <div class="dropdown" id="responsible-dropdown">
                {% for u in all_users() %}
                <a href="#" data-user="{{ u.username }}">{{ u.username }}</a>
                {% endfor %}
            </div>
        </div>
        <ul id="responsible-list"></ul>
    </div>

    <button type="submit">Save</button>
</form>

<template id="recurrence-template">
    <div class="group recurrence-item">
        <button type="button" class="remove-recurrence">
            <img src="{{ url_for('static', path='trash.svg') }}" alt="Remove" class="icon">
        </button>
        <div class="group">
            <div class="label-row">
                <span class="group-title">Type</span>
                <span class="help" data-help="Type of recurrence">?</span>
            </div>
            <select name="recurrence_type[]">
                <option value="Weekly">Weekly</option>
                <option value="MonthlyDayOfMonth">MonthlyDayOfMonth</option>
                <option value="MonthlyDayOfWeek">MonthlyDayOfWeek</option>
                <option value="AnnualDayOfMonth">AnnualDayOfMonth</option>
            </select>
        </div>
        <div class="group offset">
            <div class="label-row">
                <span class="group-title">Offset</span>
                <span class="help" data-help="Offset from nominal schedule">?</span>
            </div>
            <div class="offset-inputs">
                <div class="date-row">
                    <input type="number" name="offset_days[]" placeholder="Days" min="0">
                    <input type="number" name="offset_months[]" placeholder="Months" min="0">
                    <input type="number" name="offset_years[]" placeholder="Years" min="0">
                </div>
                <div class="time-row">
                    <input type="number" name="offset_hours[]" placeholder="Hours" min="0" max="23">
                    <input type="number" name="offset_minutes[]" placeholder="Minutes" min="0" max="59">
                </div>
            </div>
        </div>
        <div class="group">
            <div class="label-row">
                <span class="group-title">Responsible</span>
                <span class="help" data-help="People responsible for this recurrence">?</span>
            </div>
            <div class="responsible-selector recurrence-responsible-selector">
                <button type="button" class="add-responsible">Add</button>
                <div class="dropdown">
                    {% for u in all_users() %}
                    <a href="#" data-user="{{ u.username }}">{{ u.username }}</a>
                    {% endfor %}
                </div>
            </div>
            <ul class="responsible-list recurrence-responsible-list"></ul>
        </div>
        <div class="group delegations">
            <div class="label-row">
                <span class="group-title">Delegations</span>
                <span class="help" data-help="Override responsibility for a single instance">?</span>
                <button type="button" class="add-delegation icon-button">
                    <img src="{{ url_for('static', path='plus.svg') }}" alt="Add delegation" class="icon">
                </button>
            </div>
            <div class="delegations-list"></div>
            <template class="delegation-template">
                <div class="delegation-item">
                    <button type="button" class="remove-delegation"><img src="{{ url_for('static', path='trash.svg') }}" alt="Remove" class="icon"></button>
                    <input type="number" class="delegation-instance" placeholder="Instance index" min="0">
                    <div class="responsible-selector delegation-responsible-selector">
                        <button type="button" class="add-responsible">Add</button>
                        <div class="dropdown">
                            {% for u in all_users() %}
                            <a href="#" data-user="{{ u.username }}">{{ u.username }}</a>
                            {% endfor %}
                        </div>
                    </div>
                    <ul class="responsible-list delegation-responsible-list"></ul>
                </div>
            </template>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const recurrences = document.getElementById('recurrences');
    const recurrenceTemplate = document.getElementById('recurrence-template');
    const addRecurrence = document.getElementById('add-recurrence');
    const firstStart = document.getElementById('first_start');
    if (firstStart && !firstStart.value) {
        const now = new Date();
        if (
            now.getMinutes() > 0 ||
            now.getSeconds() > 0 ||
            now.getMilliseconds() > 0
        ) {
            now.setHours(now.getHours() + 1);
        }
        now.setMinutes(0, 0, 0);
        const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
            .toISOString()
            .slice(0, 16);
        firstStart.value = local;
    }

    const trashUrl = "{{ url_for('static', path='trash.svg') }}";

    function createResponsibleManager(addBtn, dropdown, list, inputName) {
        function addUser(user) {
            const li = document.createElement('li');
            li.textContent = user;
            li.dataset.user = user;
            if (inputName) {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = inputName;
                hidden.value = user;
                li.appendChild(hidden);
            }
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.innerHTML = '<img src="' + trashUrl + '" alt="Remove" class="icon">';
            btn.addEventListener('click', function () { li.remove(); });
            li.appendChild(btn);
            list.appendChild(li);
        }
        addBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            dropdown.classList.toggle('show');
        });
        dropdown.addEventListener('click', function (e) {
            if (e.target.dataset.user) {
                e.preventDefault();
                addUser(e.target.dataset.user);
                dropdown.classList.remove('show');
            }
        });
        document.addEventListener('click', function (e) {
            if (!dropdown.contains(e.target) && e.target !== addBtn) {
                dropdown.classList.remove('show');
            }
        });
        return { addUser, list };
    }

    function addRecurrenceItem(rec) {
        const fragment = recurrenceTemplate.content.cloneNode(true);
        const item = fragment.querySelector('.recurrence-item');
        if (rec) {
            fragment.querySelector('select[name="recurrence_type[]"]').value = rec.type;
            if (rec.offset) {
                if (rec.offset.exact_duration_seconds) {
                    const dur = rec.offset.exact_duration_seconds;
                    const days = Math.floor(dur / 86400);
                    const hours = Math.floor((dur % 86400) / 3600);
                    const minutes = Math.floor((dur % 3600) / 60);
                    if (days) fragment.querySelector('input[name="offset_days[]"]').value = days;
                    if (hours) fragment.querySelector('input[name="offset_hours[]"]').value = hours;
                    if (minutes) fragment.querySelector('input[name="offset_minutes[]"]').value = minutes;
                }
                if (rec.offset.months) {
                    fragment.querySelector('input[name="offset_months[]"]').value = rec.offset.months;
                }
                if (rec.offset.years) {
                    fragment.querySelector('input[name="offset_years[]"]').value = rec.offset.years;
                }
            }
        }

        const recManager = createResponsibleManager(
            item.querySelector('.recurrence-responsible-selector .add-responsible'),
            item.querySelector('.recurrence-responsible-selector .dropdown'),
            item.querySelector('.recurrence-responsible-list'),
            null
        );

        const delegationList = item.querySelector('.delegations-list');
        const delegationTemplate = item.querySelector('.delegation-template');
        function addDelegation(data) {
            const df = delegationTemplate.content.cloneNode(true);
            const delItem = df.querySelector('.delegation-item');
            delItem.querySelector('.remove-delegation').addEventListener('click', () => delItem.remove());
            const instInput = delItem.querySelector('.delegation-instance');
            const delManager = createResponsibleManager(
                delItem.querySelector('.delegation-responsible-selector .add-responsible'),
                delItem.querySelector('.delegation-responsible-selector .dropdown'),
                delItem.querySelector('.delegation-responsible-list'),
                null
            );
            if (data) {
                instInput.value = data.instance_index;
                (data.responsible || []).forEach(u => delManager.addUser(u));
            }
            delegationList.appendChild(delItem);
        }
        item.querySelector('.add-delegation').addEventListener('click', function () {
            addDelegation();
        });

        if (rec) {
            (rec.responsible || []).forEach(u => recManager.addUser(u));
            (rec.delegations || []).forEach(d => addDelegation(d));
        }

        recurrences.appendChild(fragment);
    }

    addRecurrence.addEventListener('click', function () {
        addRecurrenceItem();
    });
    recurrences.addEventListener('click', function (e) {
        if (e.target.closest('.remove-recurrence')) {
            e.target.closest('.recurrence-item').remove();
        }
    });

    const entryRespManager = createResponsibleManager(
        document.getElementById('add-responsible'),
        document.getElementById('responsible-dropdown'),
        document.getElementById('responsible-list'),
        'responsible'
    );
    const entryManagersManager = createResponsibleManager(
        document.getElementById('add-managers'),
        document.getElementById('managers-dropdown'),
        document.getElementById('managers-list'),
        'managers'
    );
    {% if not entry_data %}
    entryManagersManager.addUser('{{ current_user }}');
    {% endif %}

    {% if entry_data %}
    const data = {{ entry_data | tojson }};
    document.getElementById('title').value = data.title;
    document.getElementById('description').value = data.description;
    document.getElementById('first_start').value = data.first_start.slice(0,16);
    const dur = data.duration_seconds;
    const days = Math.floor(dur / 86400);
    const hours = Math.floor((dur % 86400) / 3600);
    const minutes = Math.floor((dur % 3600) / 60);
    document.querySelector('input[name="duration_days"]').value = days || '';
    document.querySelector('input[name="duration_hours"]').value = hours || '';
    document.querySelector('input[name="duration_minutes"]').value = minutes || '';
    if (data.none_after) {
        document.getElementById('none_after').value = data.none_after.slice(0,16);
    }
    data.recurrences.forEach(r => addRecurrenceItem(r));
    data.responsible.forEach(u => entryRespManager.addUser(u));
    data.managers.forEach(u => entryManagersManager.addUser(u));
    {% endif %}

    const form = document.getElementById('entry-form');
    const durationInputs = document.querySelectorAll('.duration-inputs input');
    function validateDuration() {
        const days = Number(document.querySelector('input[name="duration_days"]').value) || 0;
        const hours = Number(document.querySelector('input[name="duration_hours"]').value) || 0;
        const minutes = Number(document.querySelector('input[name="duration_minutes"]').value) || 0;
        const total = days * 86400 + hours * 3600 + minutes * 60;
        durationInputs.forEach(inp => {
            if (total <= 0) {
                inp.setCustomValidity('Duration must be greater than 0');
            } else {
                inp.setCustomValidity('');
            }
        });
        return total > 0;
    }
    durationInputs.forEach(inp => inp.addEventListener('input', validateDuration));
    form.addEventListener('submit', function (e) {
        if (!validateDuration()) {
            e.preventDefault();
            durationInputs[0].reportValidity();
            return;
        }
        if (entryManagersManager.list.querySelectorAll('li').length === 0) {
            e.preventDefault();
            alert('At least one manager required');
            return;
        }
        document.querySelectorAll('input[name="recurrence_responsible[]"]').forEach(el => el.remove());
        document.querySelectorAll('input[name="recurrence_delegations[]"]').forEach(el => el.remove());
        document.querySelectorAll('.recurrence-item').forEach(item => {
            const resps = Array.from(item.querySelectorAll('.recurrence-responsible-list li')).map(li => li.dataset.user);
            const hiddenR = document.createElement('input');
            hiddenR.type = 'hidden';
            hiddenR.name = 'recurrence_responsible[]';
            hiddenR.value = JSON.stringify(resps);
            form.appendChild(hiddenR);
            const delegations = [];
            item.querySelectorAll('.delegation-item').forEach(delItem => {
                const idx = parseInt(delItem.querySelector('.delegation-instance').value);
                if (!isNaN(idx)) {
                    const resp = Array.from(delItem.querySelectorAll('.delegation-responsible-list li')).map(li => li.dataset.user);
                    delegations.push({instance_index: idx, responsible: resp});
                }
            });
            const hiddenD = document.createElement('input');
            hiddenD.type = 'hidden';
            hiddenD.name = 'recurrence_delegations[]';
            hiddenD.value = JSON.stringify(delegations);
            form.appendChild(hiddenD);
        });
    });
});
</script>
{% endblock %}

