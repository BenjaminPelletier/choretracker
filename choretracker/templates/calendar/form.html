{% extends "base.html" %}

{% block title %}{% if entry %}Edit{% else %}New{% endif %} {{ entry_type }} - Chore Tracker{% endblock %}

{% block content %}
<h1>{% if entry %}Edit{% else %}New{% endif %} {{ entry_type }}</h1>
<form id="entry-form" class="form" method="post" action="{% if entry %}{{ url_for('update_calendar_entry', entry_id=entry.id) }}{% else %}{{ url_for('create_calendar_entry') }}{% endif %}">
    <input type="hidden" name="type" value="{{ entry_type }}">
    <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}">

    <div class="field">
        <div class="label-row">
            <label for="title">Title<span class="required">*</span></label>
            <span class="help" data-help="Short name for this entry">?</span>
        </div>
        <input type="text" id="title" name="title" required>
    </div>

    <div class="field">
        <div class="label-row">
            <label for="description">Description</label>
            <span class="help" data-help="More details about this entry">?</span>
        </div>
        <textarea id="description" name="description" rows="4" cols="40"></textarea>
    </div>

    <div class="field">
        <div class="label-row">
            <label for="none_before">None before</label>
            <span class="help" data-help="No instances start before this time">?</span>
        </div>
        <input type="datetime-local" id="none_before" name="none_before">
    </div>

    <div class="field">
        <div class="label-row">
            <span>Recurrences</span>
            <span class="help" data-help="Schedules on which this repeats">?</span>
            <button type="button" id="add-recurrence" class="icon-button">
                <img src="{{ url_for('static', path='plus.svg') }}" alt="Add recurrence" class="icon">
            </button>
        </div>
        <div id="recurrence-container"></div>
    </div>

    <div class="field">
        <div class="label-row">
            <label for="none_after">None after</label>
            <span class="help" data-help="No instances start after this time">?</span>
        </div>
        <input type="datetime-local" id="none_after" name="none_after">
    </div>

    <div class="field">
        <div class="label-row">
            <span>Managers</span>
            <span class="help" data-help="People who can edit this entry">?</span>
        </div>
        <span id="entry-managers-container"></span>
    </div>

    <div class="field">
        <div class="label-row">
            <span>Responsible</span>
            <span class="help" data-help="People responsible for this entry">?</span>
        </div>
        <span id="entry-responsible-container"></span>
    </div>

    <button type="submit">Save</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const recContainer = document.getElementById('recurrence-container');
    let recList = document.getElementById('recurrence-list');
    const addRecurrence = document.getElementById('add-recurrence');
    const trashUrl = "{{ url_for('static', path='trash.svg') }}";
    const plusUrl = "{{ url_for('static', path='plus.svg') }}";
    const xUrl = "{{ url_for('static', path='x.svg') }}";
    const profileUrlTemplate = "{{ url_for('profile_picture', username='__user__') }}";
    const allUsers = {{ all_users()|selectattr('username','ne','Viewer')|map(attribute='username')|list|tojson }};
    const recurrenceTypes = {{ RecurrenceType|map(attribute='value')|list|tojson }};
    const durationUrl = "{{ url_for('static', path='duration.svg') }}";
    const endTimeUrl = "{{ url_for('static', path='endtime.svg') }}";
    const recEditors = [];

    function makeBtn(url, alt) {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'icon-button';
        const img = document.createElement('img');
        img.src = url;
        img.alt = alt;
        img.className = 'icon';
        b.appendChild(img);
        return b;
    }

    function setupRecurrenceEditor(li, rec) {
        li.innerHTML = '';

        const typeSelect = document.createElement('select');
        typeSelect.className = 'inline-input';
        typeSelect.name = 'recurrence_type[]';
        recurrenceTypes.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            if (rec && rec.type === t) opt.selected = true;
            typeSelect.appendChild(opt);
        });

        const startInput = document.createElement('input');
        startInput.type = 'datetime-local';
        startInput.name = 'recurrence_first_start[]';
        startInput.className = 'inline-input';
        startInput.required = true;
        if (rec && rec.first_start) {
            startInput.value = rec.first_start.slice(0, 16);
        } else {
            const now = new Date();
            if (now.getMinutes() > 0 || now.getSeconds() > 0 || now.getMilliseconds() > 0) {
                now.setHours(now.getHours() + 1);
            }
            now.setMinutes(0, 0, 0);
            const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            startInput.value = local;
        }

        const durationWrap = document.createElement('span');
        durationWrap.className = 'duration-inputs';
        const toggleBtn = makeBtn(endTimeUrl, 'Use end time');
        const modeIcon = toggleBtn.querySelector('img');
        const durationFields = document.createElement('span');
        const daysInput = document.createElement('input');
        daysInput.type = 'number';
        daysInput.name = 'recurrence_duration_days[]';
        daysInput.placeholder = 'Days';
        daysInput.min = '0';
        const hoursInput = document.createElement('input');
        hoursInput.type = 'number';
        hoursInput.name = 'recurrence_duration_hours[]';
        hoursInput.placeholder = 'Hours';
        hoursInput.min = '0';
        const minutesInput = document.createElement('input');
        minutesInput.type = 'number';
        minutesInput.name = 'recurrence_duration_minutes[]';
        minutesInput.placeholder = 'Minutes';
        minutesInput.min = '0';
        minutesInput.max = '59';
        durationFields.appendChild(daysInput);
        durationFields.appendChild(hoursInput);
        durationFields.appendChild(minutesInput);
        const endInput = document.createElement('input');
        endInput.type = 'datetime-local';
        endInput.className = 'inline-input';
        endInput.style.display = 'none';
        endInput.disabled = true;
        durationWrap.appendChild(toggleBtn);
        durationWrap.appendChild(durationFields);
        durationWrap.appendChild(endInput);

        if (rec && rec.duration_seconds) {
            const dur = rec.duration_seconds;
            const d = Math.floor(dur / 86400);
            const h = Math.floor((dur % 86400) / 3600);
            const m = Math.floor((dur % 3600) / 60);
            if (d) daysInput.value = d;
            if (h) hoursInput.value = h;
            if (m) minutesInput.value = m;
        }

        let useEndTime = false;
        function computeDuration() {
            if (useEndTime) {
                const start = new Date(startInput.value);
                const end = new Date(endInput.value);
                return (end - start) / 1000;
            } else {
                const d = Number(daysInput.value) || 0;
                const h = Number(hoursInput.value) || 0;
                const m = Number(minutesInput.value) || 0;
                return d * 86400 + h * 3600 + m * 60;
            }
        }
        function validateDuration() {
            const total = computeDuration();
            const targets = useEndTime ? [endInput] : [daysInput, hoursInput, minutesInput];
            targets.forEach(inp => {
                if (total <= 0) {
                    inp.setCustomValidity('Duration must be greater than 0');
                } else {
                    inp.setCustomValidity('');
                }
            });
            return total > 0;
        }
        function updateEndFromInputs() {
            const start = new Date(startInput.value);
            const d = Number(daysInput.value) || 0;
            const h = Number(hoursInput.value) || 0;
            const m = Number(minutesInput.value) || 0;
            const end = new Date(start.getTime() + (d * 86400 + h * 3600 + m * 60) * 1000);
            const local = new Date(end.getTime() - end.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            endInput.value = local;
        }
        function updateInputsFromEnd() {
            const start = new Date(startInput.value);
            const end = new Date(endInput.value);
            let diff = Math.floor((end - start) / 1000);
            const d = Math.floor(diff / 86400);
            diff -= d * 86400;
            const h = Math.floor(diff / 3600);
            diff -= h * 3600;
            const m = Math.floor(diff / 60);
            daysInput.value = d || '';
            hoursInput.value = h || '';
            minutesInput.value = m || '';
        }

        toggleBtn.addEventListener('click', () => {
            useEndTime = !useEndTime;
            if (useEndTime) {
                modeIcon.src = durationUrl;
                modeIcon.alt = 'Use duration';
                durationFields.style.display = 'none';
                [daysInput, hoursInput, minutesInput].forEach(inp => {
                    inp.disabled = true;
                    inp.setCustomValidity('');
                });
                endInput.style.display = '';
                endInput.disabled = false;
                updateEndFromInputs();
            } else {
                modeIcon.src = endTimeUrl;
                modeIcon.alt = 'Use end time';
                durationFields.style.display = '';
                [daysInput, hoursInput, minutesInput].forEach(inp => {
                    inp.disabled = false;
                });
                endInput.style.display = 'none';
                endInput.disabled = true;
                endInput.setCustomValidity('');
                updateInputsFromEnd();
            }
            validateDuration();
        });

        [daysInput, hoursInput, minutesInput].forEach(inp =>
            inp.addEventListener('input', () => { if (!useEndTime) validateDuration(); })
        );
        endInput.addEventListener('input', () => { if (useEndTime) validateDuration(); });
        startInput.addEventListener('input', () => {
            if (useEndTime) {
                validateDuration();
            } else {
                updateEndFromInputs();
            }
        });

        const respContainer = document.createElement('span');
        const responsible = rec && rec.responsible ? [...rec.responsible] : [];

        function addResp(user) {
            const wrapper = document.createElement('span');
            const img = document.createElement('img');
            img.src = profileUrlTemplate.replace('__user__', encodeURIComponent(user));
            img.alt = user;
            img.className = 'profile-icon';
            const rm = makeBtn(trashUrl, 'Remove');
            rm.addEventListener('click', () => {
                wrapper.remove();
                const idx = responsible.indexOf(user);
                if (idx >= 0) responsible.splice(idx, 1);
                updateHidden();
                refreshDropdown();
            });
            wrapper.appendChild(img);
            wrapper.appendChild(rm);
            respContainer.appendChild(wrapper);
            updateHidden();
        }

        const addWrap = document.createElement('span');
        addWrap.className = 'responsible-selector';
        const addBtn = makeBtn(plusUrl, 'Add user');
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown';
        dropdown.style.display = 'none';

        function refreshDropdown() {
            dropdown.innerHTML = '';
            allUsers.filter(u => !responsible.includes(u)).forEach(u => {
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = u;
                a.addEventListener('click', e => {
                    e.preventDefault();
                    responsible.push(u);
                    addResp(u);
                    dropdown.style.display = 'none';
                    refreshDropdown();
                });
                dropdown.appendChild(a);
            });
        }

        addBtn.addEventListener('click', () => {
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        addWrap.appendChild(addBtn);
        addWrap.appendChild(dropdown);

        const respHidden = document.createElement('input');
        respHidden.type = 'hidden';
        respHidden.name = 'recurrence_responsible[]';
        const delHidden = document.createElement('input');
        delHidden.type = 'hidden';
        delHidden.name = 'recurrence_delegations[]';
        delHidden.value = '[]';

        function updateHidden() {
            respHidden.value = JSON.stringify(responsible);
        }

        responsible.forEach(u => addResp(u));
        refreshDropdown();
        updateHidden();

        const removeBtn = makeBtn(xUrl, 'Remove');
        removeBtn.addEventListener('click', () => {
            li.remove();
            const idx = recEditors.findIndex(e => e.li === li);
            if (idx >= 0) recEditors.splice(idx, 1);
            if (recList && recList.children.length === 0) {
                recContainer.innerHTML = '';
            }
        });

        const editor = {
            li,
            validate: () => {
                const ok = validateDuration();
                if (useEndTime) {
                    if (ok) {
                        updateInputsFromEnd();
                    }
                    [daysInput, hoursInput, minutesInput].forEach(inp => {
                        inp.disabled = false;
                    });
                }
                return { ok, focus: useEndTime ? endInput : daysInput };
            }
        };
        recEditors.push(editor);

        li.appendChild(typeSelect);
        li.appendChild(startInput);
        li.appendChild(durationWrap);
        li.appendChild(respContainer);
        li.appendChild(addWrap);
        li.appendChild(respHidden);
        li.appendChild(delHidden);
        li.appendChild(removeBtn);
    }

    addRecurrence.addEventListener('click', () => {
        if (!recList) {
            recList = document.createElement('ul');
            recList.id = 'recurrence-list';
            recContainer.appendChild(recList);
        }
        const li = document.createElement('li');
        li.className = 'recurrence-item';
        recList.appendChild(li);
        setupRecurrenceEditor(li, null);
    });

    function setupUserSelector(containerId, inputName, initialUsers) {
        const container = document.getElementById(containerId);
        const users = [...initialUsers];
        container.innerHTML = '';
        const userContainer = document.createElement('span');
        const addWrap = document.createElement('span');
        addWrap.className = 'responsible-selector';
        const addBtn = makeBtn(plusUrl, 'Add user');
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown';
        dropdown.style.display = 'none';

        function refreshDropdown() {
            dropdown.innerHTML = '';
            allUsers.filter(u => !users.includes(u)).forEach(u => {
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = u;
                a.addEventListener('click', e => {
                    e.preventDefault();
                    users.push(u);
                    addUser(u);
                    dropdown.style.display = 'none';
                    refreshDropdown();
                });
                dropdown.appendChild(a);
            });
        }

        function addUser(user) {
            const wrapper = document.createElement('span');
            const img = document.createElement('img');
            img.src = profileUrlTemplate.replace('__user__', encodeURIComponent(user));
            img.alt = user;
            img.className = 'profile-icon';
            const rm = makeBtn(trashUrl, 'Remove');
            rm.addEventListener('click', () => {
                wrapper.remove();
                const idx = users.indexOf(user);
                if (idx >= 0) users.splice(idx, 1);
                refreshDropdown();
            });
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = inputName;
            hidden.value = user;
            wrapper.appendChild(img);
            wrapper.appendChild(rm);
            wrapper.appendChild(hidden);
            userContainer.appendChild(wrapper);
        }

        addBtn.addEventListener('click', () => {
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        addWrap.appendChild(addBtn);
        addWrap.appendChild(dropdown);

        users.forEach(u => addUser(u));
        refreshDropdown();

        container.appendChild(userContainer);
        container.appendChild(addWrap);

        return { users };
    }
    const initialManagers = [];
    const initialResponsible = [];

    {% if entry_data %}
    const data = {{ entry_data | tojson }};
    document.getElementById('title').value = data.title;
    document.getElementById('description').value = data.description;
    if (data.none_before) {
        document.getElementById('none_before').value = data.none_before.slice(0,16);
    }
    if (data.none_after) {
        document.getElementById('none_after').value = data.none_after.slice(0,16);
    }
    if (!recList) {
        recList = document.createElement('ul');
        recList.id = 'recurrence-list';
        recContainer.appendChild(recList);
    }
    data.recurrences.forEach(r => {
        const li = document.createElement('li');
        li.className = 'recurrence-item';
        recList.appendChild(li);
        setupRecurrenceEditor(li, r);
    });
    initialResponsible.push(...data.responsible);
    initialManagers.push(...data.managers);
    {% else %}
    initialManagers.push('{{ current_user }}');
    {% endif %}

    const entryRespSelector = setupUserSelector('entry-responsible-container', 'responsible', initialResponsible);
    const entryManagersSelector = setupUserSelector('entry-managers-container', 'managers', initialManagers);

    const form = document.getElementById('entry-form');
    form.addEventListener('submit', function (e) {
        for (const editor of recEditors) {
            const res = editor.validate();
            if (!res.ok) {
                e.preventDefault();
                res.focus.reportValidity();
                return;
            }
        }
        if (entryManagersSelector.users.length === 0) {
            e.preventDefault();
            alert('At least one manager required');
            return;
        }
        const entryType = document.querySelector('input[name="type"]').value;
        if (entryType === 'Chore' && entryRespSelector.users.length === 0) {
            e.preventDefault();
            alert('At least one responsible user required');
            return;
        }
    });
});
</script>
{% endblock %}
