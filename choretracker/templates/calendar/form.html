{% extends "base.html" %}

{% block title %}{% if entry %}Edit{% else %}New{% endif %} {{ entry_type }} - Chore Tracker{% endblock %}

{% block content %}
<h1>{% if entry %}Edit{% else %}New{% endif %} {{ entry_type }}</h1>
<form id="entry-form" class="form" method="post" action="{% if entry %}{{ url_for('update_calendar_entry', entry_id=entry.id) }}{% else %}{{ url_for('create_calendar_entry') }}{% endif %}">
    <input type="hidden" name="type" value="{{ entry_type }}">
    <input type="hidden" name="csrf_token" value="{{ request.session['csrf_token'] }}">

    <div class="field">
        <div class="label-row">
            <label for="title">Title<span class="required">*</span></label>
            <span class="help" data-help="Short name for this entry">?</span>
        </div>
        <input type="text" id="title" name="title" required>
    </div>

    <div class="field">
        <div class="label-row">
            <label for="description">Description</label>
            <span class="help" data-help="More details about this entry">?</span>
        </div>
        <textarea id="description" name="description" rows="3"></textarea>
    </div>

    <div class="field">
        <div class="label-row">
            <label for="first_start">First start<span class="required">*</span></label>
            <span class="help" data-help="Start time of the first instance">?</span>
        </div>
        <input type="datetime-local" id="first_start" name="first_start" required>
    </div>

    <div class="field">
        <div class="label-row">
            <span>Duration<span class="required">*</span></span>
            <span class="help" data-help="Length of each instance">?</span>
        </div>
        <div class="duration-inputs">
            <input type="number" name="duration_days" placeholder="Days" min="0">
            <input type="number" name="duration_hours" placeholder="Hours" min="0">
            <input type="number" name="duration_minutes" placeholder="Minutes" min="0" max="59">
        </div>
    </div>

    <div class="field">
        <div class="label-row">
            <span>Recurrences</span>
            <span class="help" data-help="Schedules on which this repeats">?</span>
            <button type="button" id="add-recurrence" class="icon-button">
                <img src="{{ url_for('static', path='plus.svg') }}" alt="Add recurrence" class="icon">
            </button>
        </div>
        <div id="recurrence-container"></div>
    </div>

    <div class="field">
        <div class="label-row">
            <label for="none_after">None after</label>
            <span class="help" data-help="No instances start after this time">?</span>
        </div>
        <input type="datetime-local" id="none_after" name="none_after">
    </div>

    <div class="field">
        <div class="label-row">
            <span>Managers</span>
            <span class="help" data-help="People who can edit this entry">?</span>
        </div>
        <span id="entry-managers-container"></span>
    </div>

    <div class="field">
        <div class="label-row">
            <span>Responsible</span>
            <span class="help" data-help="People responsible for this entry">?</span>
        </div>
        <span id="entry-responsible-container"></span>
    </div>

    <button type="submit">Save</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const recContainer = document.getElementById('recurrence-container');
    let recList = document.getElementById('recurrence-list');
    const addRecurrence = document.getElementById('add-recurrence');
    const firstStart = document.getElementById('first_start');
    if (firstStart && !firstStart.value) {
        const now = new Date();
        if (now.getMinutes() > 0 || now.getSeconds() > 0 || now.getMilliseconds() > 0) {
            now.setHours(now.getHours() + 1);
        }
        now.setMinutes(0, 0, 0);
        const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
            .toISOString()
            .slice(0, 16);
        firstStart.value = local;
    }

    const trashUrl = "{{ url_for('static', path='trash.svg') }}";
    const plusUrl = "{{ url_for('static', path='plus.svg') }}";
    const xUrl = "{{ url_for('static', path='x.svg') }}";
    const profileUrlTemplate = "{{ url_for('profile_picture', username='__user__') }}";
    const allUsers = {{ all_users()|selectattr('username','ne','Viewer')|map(attribute='username')|list|tojson }};
    const recurrenceTypes = {{ RecurrenceType|map(attribute='value')|list|tojson }};

    function makeBtn(url, alt) {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'icon-button';
        const img = document.createElement('img');
        img.src = url;
        img.alt = alt;
        img.className = 'icon';
        b.appendChild(img);
        return b;
    }

    function setupRecurrenceEditor(li, rec) {
        const offsetSeconds = rec && rec.offset && rec.offset.exact_duration_seconds ? rec.offset.exact_duration_seconds : 0;
        const days = Math.floor(offsetSeconds / 86400);
        const hours = Math.floor((offsetSeconds % 86400) / 3600);
        const minutes = Math.floor((offsetSeconds % 3600) / 60);
        li.innerHTML = '';

        const typeSelect = document.createElement('select');
        typeSelect.className = 'inline-input';
        typeSelect.name = 'recurrence_type[]';
        recurrenceTypes.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            if (rec && rec.type === t) opt.selected = true;
            typeSelect.appendChild(opt);
        });

        const durationSpan = document.createElement('span');
        const durLabel = document.createElement('span');
        durLabel.textContent = 'Offset: ';
        durationSpan.appendChild(durLabel);
        const dayInput = document.createElement('input');
        dayInput.type = 'number';
        dayInput.placeholder = 'Days';
        dayInput.min = '0';
        dayInput.name = 'offset_days[]';
        dayInput.className = 'inline-input';
        if (days) dayInput.value = days;
        dayInput.style.width = '4ch';
        const hourInput = document.createElement('input');
        hourInput.type = 'number';
        hourInput.placeholder = 'Hours';
        hourInput.min = '0';
        hourInput.name = 'offset_hours[]';
        hourInput.className = 'inline-input';
        if (hours) hourInput.value = hours;
        hourInput.style.width = '4ch';
        const minuteInput = document.createElement('input');
        minuteInput.type = 'number';
        minuteInput.placeholder = 'Minutes';
        minuteInput.min = '0';
        minuteInput.max = '59';
        minuteInput.name = 'offset_minutes[]';
        minuteInput.className = 'inline-input';
        if (minutes) minuteInput.value = minutes;
        minuteInput.style.width = '4ch';
        const monthInput = document.createElement('input');
        monthInput.type = 'hidden';
        monthInput.name = 'offset_months[]';
        monthInput.value = rec && rec.offset && rec.offset.months ? rec.offset.months : 0;
        const yearInput = document.createElement('input');
        yearInput.type = 'hidden';
        yearInput.name = 'offset_years[]';
        yearInput.value = rec && rec.offset && rec.offset.years ? rec.offset.years : 0;
        durationSpan.appendChild(dayInput);
        durationSpan.appendChild(hourInput);
        durationSpan.appendChild(minuteInput);
        durationSpan.appendChild(monthInput);
        durationSpan.appendChild(yearInput);

        const respContainer = document.createElement('span');
        const responsible = rec && rec.responsible ? [...rec.responsible] : [];

        function addResp(user) {
            const wrapper = document.createElement('span');
            const img = document.createElement('img');
            img.src = profileUrlTemplate.replace('__user__', encodeURIComponent(user));
            img.alt = user;
            img.className = 'profile-icon';
            const rm = makeBtn(trashUrl, 'Remove');
            rm.addEventListener('click', () => {
                wrapper.remove();
                const idx = responsible.indexOf(user);
                if (idx >= 0) responsible.splice(idx, 1);
                updateHidden();
                refreshDropdown();
            });
            wrapper.appendChild(img);
            wrapper.appendChild(rm);
            respContainer.appendChild(wrapper);
            updateHidden();
        }

        const addWrap = document.createElement('span');
        addWrap.className = 'responsible-selector';
        const addBtn = makeBtn(plusUrl, 'Add user');
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown';
        dropdown.style.display = 'none';

        function refreshDropdown() {
            dropdown.innerHTML = '';
            allUsers.filter(u => !responsible.includes(u)).forEach(u => {
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = u;
                a.addEventListener('click', e => {
                    e.preventDefault();
                    responsible.push(u);
                    addResp(u);
                    dropdown.style.display = 'none';
                    refreshDropdown();
                });
                dropdown.appendChild(a);
            });
        }

        addBtn.addEventListener('click', () => {
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        addWrap.appendChild(addBtn);
        addWrap.appendChild(dropdown);

        const respHidden = document.createElement('input');
        respHidden.type = 'hidden';
        respHidden.name = 'recurrence_responsible[]';
        const delHidden = document.createElement('input');
        delHidden.type = 'hidden';
        delHidden.name = 'recurrence_delegations[]';
        delHidden.value = '[]';

        function updateHidden() {
            respHidden.value = JSON.stringify(responsible);
        }

        responsible.forEach(u => addResp(u));
        refreshDropdown();
        updateHidden();

        const removeBtn = makeBtn(xUrl, 'Remove');
        removeBtn.addEventListener('click', () => {
            li.remove();
            if (recList && recList.children.length === 0) {
                recContainer.innerHTML = '';
            }
        });

        li.appendChild(typeSelect);
        li.appendChild(durationSpan);
        li.appendChild(respContainer);
        li.appendChild(addWrap);
        li.appendChild(respHidden);
        li.appendChild(delHidden);
        li.appendChild(removeBtn);
    }

    addRecurrence.addEventListener('click', () => {
        if (!recList) {
            recList = document.createElement('ul');
            recList.id = 'recurrence-list';
            recContainer.appendChild(recList);
        }
        const li = document.createElement('li');
        li.className = 'recurrence-item';
        recList.appendChild(li);
        setupRecurrenceEditor(li, null);
    });

    function setupUserSelector(containerId, inputName, initialUsers) {
        const container = document.getElementById(containerId);
        const users = [...initialUsers];
        container.innerHTML = '';
        const userContainer = document.createElement('span');
        const addWrap = document.createElement('span');
        addWrap.className = 'responsible-selector';
        const addBtn = makeBtn(plusUrl, 'Add user');
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown';
        dropdown.style.display = 'none';

        function refreshDropdown() {
            dropdown.innerHTML = '';
            allUsers.filter(u => !users.includes(u)).forEach(u => {
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = u;
                a.addEventListener('click', e => {
                    e.preventDefault();
                    users.push(u);
                    addUser(u);
                    dropdown.style.display = 'none';
                    refreshDropdown();
                });
                dropdown.appendChild(a);
            });
        }

        function addUser(user) {
            const wrapper = document.createElement('span');
            const img = document.createElement('img');
            img.src = profileUrlTemplate.replace('__user__', encodeURIComponent(user));
            img.alt = user;
            img.className = 'profile-icon';
            const rm = makeBtn(trashUrl, 'Remove');
            rm.addEventListener('click', () => {
                wrapper.remove();
                const idx = users.indexOf(user);
                if (idx >= 0) users.splice(idx, 1);
                refreshDropdown();
            });
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = inputName;
            hidden.value = user;
            wrapper.appendChild(img);
            wrapper.appendChild(rm);
            wrapper.appendChild(hidden);
            userContainer.appendChild(wrapper);
        }

        addBtn.addEventListener('click', () => {
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        addWrap.appendChild(addBtn);
        addWrap.appendChild(dropdown);

        users.forEach(u => addUser(u));
        refreshDropdown();

        container.appendChild(userContainer);
        container.appendChild(addWrap);

        return { users };
    }

    const initialManagers = [];
    const initialResponsible = [];

    {% if entry_data %}
    const data = {{ entry_data | tojson }};
    document.getElementById('title').value = data.title;
    document.getElementById('description').value = data.description;
    document.getElementById('first_start').value = data.first_start.slice(0,16);
    const dur = data.duration_seconds;
    const days = Math.floor(dur / 86400);
    const hours = Math.floor((dur % 86400) / 3600);
    const minutes = Math.floor((dur % 3600) / 60);
    document.querySelector('input[name="duration_days"]').value = days || '';
    document.querySelector('input[name="duration_hours"]').value = hours || '';
    document.querySelector('input[name="duration_minutes"]').value = minutes || '';
    if (data.none_after) {
        document.getElementById('none_after').value = data.none_after.slice(0,16);
    }
    if (!recList) {
        recList = document.createElement('ul');
        recList.id = 'recurrence-list';
        recContainer.appendChild(recList);
    }
    data.recurrences.forEach(r => {
        const li = document.createElement('li');
        li.className = 'recurrence-item';
        recList.appendChild(li);
        setupRecurrenceEditor(li, r);
    });
    initialResponsible.push(...data.responsible);
    initialManagers.push(...data.managers);
    {% else %}
    initialManagers.push('{{ current_user }}');
    {% endif %}

    const entryRespSelector = setupUserSelector('entry-responsible-container', 'responsible', initialResponsible);
    const entryManagersSelector = setupUserSelector('entry-managers-container', 'managers', initialManagers);

    const form = document.getElementById('entry-form');
    const durationInputs = document.querySelectorAll('.duration-inputs input');
    function validateDuration() {
        const days = Number(document.querySelector('input[name="duration_days"]').value) || 0;
        const hours = Number(document.querySelector('input[name="duration_hours"]').value) || 0;
        const minutes = Number(document.querySelector('input[name="duration_minutes"]').value) || 0;
        const total = days * 86400 + hours * 3600 + minutes * 60;
        durationInputs.forEach(inp => {
            if (total <= 0) {
                inp.setCustomValidity('Duration must be greater than 0');
            } else {
                inp.setCustomValidity('');
            }
        });
        return total > 0;
    }
    durationInputs.forEach(inp => inp.addEventListener('input', validateDuration));
    form.addEventListener('submit', function (e) {
        if (!validateDuration()) {
            e.preventDefault();
            durationInputs[0].reportValidity();
            return;
        }
        if (entryManagersSelector.users.length === 0) {
            e.preventDefault();
            alert('At least one manager required');
            return;
        }
        const entryType = document.querySelector('input[name="type"]').value;
        if (entryType === 'Chore' && entryRespSelector.users.length === 0) {
            e.preventDefault();
            alert('At least one responsible user required');
            return;
        }
    });
});
</script>
{% endblock %}

