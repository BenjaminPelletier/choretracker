{% extends "base.html" %}

{% block title %}{{ entry.title }} {{ entry.type.value }} - Chore Tracker{% endblock %}

{% block content %}
<h1>{{ entry.title }} {{ entry.type.value }}
    {% if can_edit %}
    <a href="{{ url_for('edit_calendar_entry', entry_id=entry.id) }}" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></a>
    <form method="post" action="{{ url_for('delete_calendar_entry', entry_id=entry.id) }}" style="display:inline" onsubmit="return confirm('Are you sure you want to delete this entry?');">
        <button type="submit" class="icon-button"><img src="{{ url_for('static', path='trash.svg') }}" alt="Delete" class="icon"></button>
    </form>
    {% endif %}
</h1>
<div class="description">{{ entry.description|markdown }}</div>
<dl>
    <dt>First start: {{ entry.first_start|format_datetime(include_day=True) }}</dt>
    <dt>Duration: {{ entry.duration|format_duration }}</dt>
    <dt>Recurrences</dt>
    <dd>
        {% if entry.recurrences %}
        <ul>
            {% for rec in entry.recurrences %}
            <li>{{ rec.type.value }}{% if rec.offset %} (offset: {{ rec.offset|format_offset }}){% endif %}</li>
            {% endfor %}
        </ul>
        {% else %}
        None
        {% endif %}
    </dd>
    {% if entry.recurrences %}
        {% if entry.none_after %}
    <dt>None after: {{ entry.none_after|format_datetime(include_day=True) }}</dt>
        {% else %}
    <dt>Repeats forever</dt>
        {% endif %}
    {% endif %}
    <dt>Responsible</dt><dd>{{ entry.responsible|join(', ') }}</dd>
    <dt>Owner</dt><dd>{{ entry.owner }}</dd>
</dl>
{% if completions %}
<h2>Completions</h2>
<ul class="time-list">
    {% for comp, period, can_remove in completions %}
    <li>
        {{ comp.completed_by }} {{ comp.completed_at|format_datetime }}
        <a href="{{ url_for('view_time_period', entry_id=entry.id, rindex=comp.recurrence_index, iindex=comp.instance_index) }}">due {{ period.end|format_datetime }}</a>
        {% if can_remove %}
        <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ comp.recurrence_index }}" data-iindex="{{ comp.instance_index }}" data-action="remove" />
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endif %}
<script>
document.querySelectorAll('.checkbox-icon[data-action="remove"]').forEach(el => {
    el.addEventListener('click', async () => {
        const entry = el.dataset.entry;
        const r = parseInt(el.dataset.rindex);
        const i = parseInt(el.dataset.iindex);
        await fetch(`/calendar/${entry}/completion/remove`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({recurrence_index: r, instance_index: i})
        });
        location.reload();
    });
});
</script>
{% endblock %}
