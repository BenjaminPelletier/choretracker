{% extends "base.html" %}

{% block title %}{{ entry.title }} {{ entry.type.value }} - Chore Tracker{% endblock %}

{% block content %}
<h1 id="title-type">
    <span id="title-text">{{ entry.title }}</span>
    <span id="type-text">{{ entry.type.value }}</span>
    {% if can_edit %}
    <button type="button" id="edit-title-type" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
    <form method="post" action="{{ url_for('delete_calendar_entry', entry_id=entry.id) }}" style="display:inline" onsubmit="return confirm('Are you sure you want to delete this entry?');">
        <button type="submit" class="icon-button"><img src="{{ url_for('static', path='trash.svg') }}" alt="Delete" class="icon"></button>
    </form>
    {% endif %}
</h1>
<div class="description" id="description-container">
    <div id="description-text">{{ entry.description|markdown }}</div>
    {% if can_edit %}
    <button type="button" id="edit-description" class="icon-button" data-desc="{{ entry.description|b64encode }}"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
    {% endif %}
</div>
<dl>
    <dt>First start: <span id="first-start-container">
        <span id="first-start-text">{{ entry.first_start|format_datetime(include_day=True) }}</span>
        {% if can_edit %}
        <button type="button" id="edit-first-start" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
        {% endif %}
    </span></dt>
    <dt>Duration: <span id="duration-container" data-duration-seconds="{{ entry.duration.total_seconds()|int }}">
        <span id="duration-text">{{ entry.duration|format_duration }}</span>
        {% if can_edit %}
        <button type="button" id="edit-duration" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
        {% endif %}
    </span></dt>
    <dt>Recurrences{% if can_edit %} <button type="button" id="add-recurrence" class="icon-button"><img src="{{ url_for('static', path='plus.svg') }}" alt="Add recurrence" class="icon"></button>{% endif %}</dt>
    <dd id="recurrence-container">
        {% if entry.recurrences %}
        <ul id="recurrence-list">
            {% for rec in entry.recurrences %}
            <li class="recurrence-item" data-rindex="{{ loop.index0 }}" data-type="{{ rec.type.value }}" data-offset-seconds="{{ rec.offset.exact_duration_seconds if rec.offset and rec.offset.exact_duration_seconds else 0 }}" data-responsible='{{ rec.responsible|tojson }}'>
                <span class="recurrence-text">{{ rec.type.value }}{% if rec.offset %} (offset: {{ rec.offset|format_offset }}){% endif %}</span>
                {% for user in rec.responsible %}
                <img src="{{ request.url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
                {% endfor %}
                {% if can_edit %}
                <button type="button" class="icon-button edit-recurrence"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
                <button type="button" class="icon-button delete-recurrence"><img src="{{ url_for('static', path='trash.svg') }}" alt="Delete" class="icon"></button>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        None
        {% endif %}
    </dd>
    {% if entry.recurrences %}
        <dt id="none-after-row" data-current="{{ entry.none_after.strftime('%Y-%m-%dT%H:%M') if entry.none_after else '' }}">
            {% if entry.none_after %}
            None after: <span id="none-after-text">{{ entry.none_after|format_datetime(include_day=True) }}</span>
            {% else %}
            Repeats forever
            {% endif %}
            {% if can_edit %}
            <button type="button" id="edit-none-after" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
            {% endif %}
        </dt>
    {% endif %}
    <dt>Responsible: <span id="entry-responsible-container" data-responsible='{{ entry.responsible|tojson }}'>
        {% for user in entry.responsible %}
        <img src="{{ request.url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
        {% endfor %}
        {% if can_edit %}
        <button type="button" id="edit-responsible" class="icon-button"><img src="{{ url_for('static', path='pen.svg') }}" alt="Edit" class="icon"></button>
        {% endif %}
    </span></dt>
    <dt>Owner</dt><dd>{{ entry.owner }}</dd>
</dl>
{% if past_instances or upcoming_instances %}
<h2>Instances</h2>
    {% if past_instances %}
    <h3>Past <a href="{{ url_for('view_calendar_entry', entry_id=entry.id) }}?past_entries={{ past_entries + 5 }}&upcoming_entries={{ upcoming_entries }}" class="icon-button"><img src="{{ url_for('static', path='plus.svg') }}" alt="Show more past instances" class="icon"></a></h3>
    <ul class="time-list">
        {% for period, completion, can_remove, is_skipped, responsible in past_instances %}
        <li>
            <a href="{{ url_for('view_time_period', entry_id=entry.id, rindex=period.recurrence_index, iindex=period.instance_index) }}">Due {{ period.end|format_datetime(include_day=True) }}</a>
            {% for user in responsible %}
            <img src="{{ request.url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
            {% endfor %}
            {% if completion %}
            <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ completion.recurrence_index }}" data-iindex="{{ completion.instance_index }}" {% if can_remove %}data-action="remove"{% endif %} />
            <img src="{{ request.url_for('profile_picture', username=completion.completed_by) }}" alt="{{ completion.completed_by }}" class="profile-icon" />
            {{ completion.completed_at|format_completion_time(period.end) }}
            {% endif %}
            {% if is_skipped %} (skipped){% endif %}
        </li>
        {% endfor %}
    </ul>
    {% endif %}
    {% if upcoming_instances %}
    <h3>Upcoming <a href="{{ url_for('view_calendar_entry', entry_id=entry.id) }}?past_entries={{ past_entries }}&upcoming_entries={{ upcoming_entries + 5 }}" class="icon-button"><img src="{{ url_for('static', path='plus.svg') }}" alt="Show more upcoming instances" class="icon"></a></h3>
    <ul class="time-list">
        {% for period, completion, can_remove, is_skipped, responsible in upcoming_instances %}
        <li>
            <a href="{{ url_for('view_time_period', entry_id=entry.id, rindex=period.recurrence_index, iindex=period.instance_index) }}">Due {{ period.end|format_datetime(include_day=True) }}</a>
            {% for user in responsible %}
            <img src="{{ request.url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
            {% endfor %}
            {% if is_skipped %} (skipped){% endif %}
        </li>
        {% endfor %}
    </ul>
    {% endif %}
{% endif %}
<script>
document.querySelectorAll('.checkbox-icon[data-action="remove"]').forEach(el => {
    el.addEventListener('click', async () => {
        const entry = el.dataset.entry;
        const r = parseInt(el.dataset.rindex);
        const i = parseInt(el.dataset.iindex);
        await fetch(`/calendar/${entry}/completion/remove`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({recurrence_index: r, instance_index: i})
        });
        location.reload();
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const entryId = {{ entry.id }};
    const diskUrl = "{{ url_for('static', path='disk.svg') }}";
    const xUrl = "{{ url_for('static', path='x.svg') }}";
    const trashUrl = "{{ url_for('static', path='trash.svg') }}";
    const plusUrl = "{{ url_for('static', path='plus.svg') }}";
    const profileUrlTemplate = "{{ request.url_for('profile_picture', username='__user__') }}";
    const allUsers = {{ all_users()|selectattr('username','ne','Viewer')|map(attribute='username')|list|tojson }};
    const recurrenceTypes = {{ RecurrenceType|map(attribute='value')|list|tojson }};

    function makeBtn(url, alt) {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'icon-button';
        const img = document.createElement('img');
        img.src = url;
        img.alt = alt;
        img.className = 'icon';
        b.appendChild(img);
        return b;
    }

    const fsEdit = document.getElementById('edit-first-start');
    if (fsEdit) {
        fsEdit.addEventListener('click', () => {
            const container = document.getElementById('first-start-container');
            const input = document.createElement('input');
            input.type = 'datetime-local';
            input.value = "{{ entry.first_start.strftime('%Y-%m-%dT%H:%M') }}";
            input.className = 'inline-input';
            const save = makeBtn(diskUrl, 'Save');
            const cancel = makeBtn(xUrl, 'Cancel');
            container.innerHTML = '';
            container.appendChild(input);
            container.appendChild(save);
            container.appendChild(cancel);
            save.addEventListener('click', async () => {
                await fetch(`/calendar/${entryId}/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({first_start: input.value})
                });
                location.reload();
            });
            cancel.addEventListener('click', () => location.reload());
        });
    }

    const durEdit = document.getElementById('edit-duration');
    if (durEdit) {
        durEdit.addEventListener('click', () => {
            const container = document.getElementById('duration-container');
            const total = parseInt(container.dataset.durationSeconds || '0');
            const days = Math.floor(total / 86400);
            const hours = Math.floor((total % 86400) / 3600);
            const minutes = Math.floor((total % 3600) / 60);
            container.innerHTML = '';
            const dayInput = document.createElement('input');
            dayInput.type = 'number';
            dayInput.placeholder = 'Days';
            dayInput.min = '0';
            dayInput.className = 'inline-input';
            if (days) dayInput.value = days;
            dayInput.style.width = '4ch';
            const hourInput = document.createElement('input');
            hourInput.type = 'number';
            hourInput.placeholder = 'Hours';
            hourInput.min = '0';
            hourInput.className = 'inline-input';
            if (hours) hourInput.value = hours;
            hourInput.style.width = '4ch';
            const minuteInput = document.createElement('input');
            minuteInput.type = 'number';
            minuteInput.placeholder = 'Minutes';
            minuteInput.min = '0';
            minuteInput.max = '59';
            minuteInput.className = 'inline-input';
            if (minutes) minuteInput.value = minutes;
            minuteInput.style.width = '4ch';
            const save = makeBtn(diskUrl, 'Save');
            const cancel = makeBtn(xUrl, 'Cancel');
            container.appendChild(dayInput);
            container.appendChild(hourInput);
            container.appendChild(minuteInput);
            container.appendChild(save);
            container.appendChild(cancel);
            save.addEventListener('click', async () => {
                await fetch(`/calendar/${entryId}/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        duration_days: parseInt(dayInput.value || '0'),
                        duration_hours: parseInt(hourInput.value || '0'),
                        duration_minutes: parseInt(minuteInput.value || '0')
                    })
                });
                location.reload();
            });
            cancel.addEventListener('click', () => location.reload());
        });
    }

    const naEdit = document.getElementById('edit-none-after');
    if (naEdit) {
        naEdit.addEventListener('click', () => {
            const row = document.getElementById('none-after-row');
            const current = row.dataset.current;
            row.innerHTML = '';
            const label = document.createElement('span');
            label.textContent = 'Never after: ';
            const input = document.createElement('input');
            input.type = 'datetime-local';
            if (current) input.value = current;
            input.className = 'inline-input';
            const clearBtn = makeBtn(trashUrl, 'Clear');
            const save = makeBtn(diskUrl, 'Save');
            const cancel = makeBtn(xUrl, 'Cancel');
            row.appendChild(label);
            row.appendChild(input);
            row.appendChild(clearBtn);
            row.appendChild(save);
            row.appendChild(cancel);
            clearBtn.addEventListener('click', () => { input.value = ''; });
            save.addEventListener('click', async () => {
                await fetch(`/calendar/${entryId}/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ none_after: input.value })
                });
                location.reload();
            });
            cancel.addEventListener('click', () => location.reload());
        });
    }

    const respEdit = document.getElementById('edit-responsible');
    if (respEdit) {
        respEdit.addEventListener('click', () => {
            const container = document.getElementById('entry-responsible-container');
            const responsible = JSON.parse(container.dataset.responsible || '[]');
            container.innerHTML = '';
            const respContainer = document.createElement('span');

            function addResp(user) {
                const wrapper = document.createElement('span');
                const img = document.createElement('img');
                img.src = profileUrlTemplate.replace('__user__', encodeURIComponent(user));
                img.alt = user;
                img.className = 'profile-icon';
                const rm = makeBtn(trashUrl, 'Remove');
                rm.addEventListener('click', () => {
                    wrapper.remove();
                    const idx = responsible.indexOf(user);
                    if (idx >= 0) responsible.splice(idx, 1);
                    refreshDropdown();
                });
                wrapper.appendChild(img);
                wrapper.appendChild(rm);
                respContainer.appendChild(wrapper);
            }

            const addWrap = document.createElement('span');
            addWrap.className = 'responsible-selector';
            const addBtn = makeBtn(plusUrl, 'Add user');
            const dropdown = document.createElement('div');
            dropdown.className = 'dropdown';
            dropdown.style.display = 'none';

            function refreshDropdown() {
                dropdown.innerHTML = '';
                allUsers.filter(u => !responsible.includes(u)).forEach(u => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = u;
                    a.addEventListener('click', e => {
                        e.preventDefault();
                        responsible.push(u);
                        addResp(u);
                        dropdown.style.display = 'none';
                        refreshDropdown();
                    });
                    dropdown.appendChild(a);
                });
            }

            addBtn.addEventListener('click', () => {
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            });

            addWrap.appendChild(addBtn);
            addWrap.appendChild(dropdown);

            responsible.forEach(u => addResp(u));
            refreshDropdown();

            const save = makeBtn(diskUrl, 'Save');
            const cancel = makeBtn(xUrl, 'Cancel');

            container.appendChild(respContainer);
            container.appendChild(addWrap);
            container.appendChild(save);
            container.appendChild(cancel);

            save.addEventListener('click', async () => {
                await fetch(`/calendar/${entryId}/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({responsible: responsible})
                });
                location.reload();
            });
            cancel.addEventListener('click', () => location.reload());
        });
    }

    const recContainer = document.getElementById('recurrence-container');
    let recList = document.getElementById('recurrence-list');

    function setupRecurrenceEditor(li, rindex, originalType, originalResp, offsetSeconds, isNew) {
        const days = Math.floor(offsetSeconds / 86400);
        const hours = Math.floor((offsetSeconds % 86400) / 3600);
        const minutes = Math.floor((offsetSeconds % 3600) / 60);
        li.innerHTML = '';

        const typeSelect = document.createElement('select');
        typeSelect.className = 'inline-input';
        recurrenceTypes.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            if (t === originalType) opt.selected = true;
            typeSelect.appendChild(opt);
        });

        const durationSpan = document.createElement('span');
        const durLabel = document.createElement('span');
        durLabel.textContent = 'Offset: ';
        durationSpan.appendChild(durLabel);
        const dayInput = document.createElement('input');
        dayInput.type = 'number';
        dayInput.placeholder = 'Days';
        dayInput.min = '0';
        dayInput.className = 'inline-input';
        if (days) dayInput.value = days;
        dayInput.style.width = '4ch';
        const hourInput = document.createElement('input');
        hourInput.type = 'number';
        hourInput.placeholder = 'Hours';
        hourInput.min = '0';
        hourInput.className = 'inline-input';
        if (hours) hourInput.value = hours;
        hourInput.style.width = '4ch';
        const minuteInput = document.createElement('input');
        minuteInput.type = 'number';
        minuteInput.placeholder = 'Minutes';
        minuteInput.min = '0';
        minuteInput.max = '59';
        minuteInput.className = 'inline-input';
        if (minutes) minuteInput.value = minutes;
        minuteInput.style.width = '4ch';
        durationSpan.appendChild(dayInput);
        durationSpan.appendChild(hourInput);
        durationSpan.appendChild(minuteInput);

        const respContainer = document.createElement('span');
        const responsible = [...originalResp];

        function addResp(user) {
            const wrapper = document.createElement('span');
            const img = document.createElement('img');
            img.src = profileUrlTemplate.replace('__user__', encodeURIComponent(user));
            img.alt = user;
            img.className = 'profile-icon';
            const rm = makeBtn(trashUrl, 'Remove');
            rm.addEventListener('click', () => {
                wrapper.remove();
                const idx = responsible.indexOf(user);
                if (idx >= 0) responsible.splice(idx, 1);
                refreshDropdown();
            });
            wrapper.appendChild(img);
            wrapper.appendChild(rm);
            respContainer.appendChild(wrapper);
        }

        const addWrap = document.createElement('span');
        addWrap.className = 'responsible-selector';
        const addBtn = makeBtn(plusUrl, 'Add user');
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown';
        dropdown.style.display = 'none';

        function refreshDropdown() {
            dropdown.innerHTML = '';
            allUsers.filter(u => !responsible.includes(u)).forEach(u => {
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = u;
                a.addEventListener('click', e => {
                    e.preventDefault();
                    responsible.push(u);
                    addResp(u);
                    dropdown.style.display = 'none';
                    refreshDropdown();
                });
                dropdown.appendChild(a);
            });
        }

        addBtn.addEventListener('click', () => {
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        addWrap.appendChild(addBtn);
        addWrap.appendChild(dropdown);

        originalResp.forEach(u => addResp(u));
        refreshDropdown();

        const save = makeBtn(diskUrl, 'Save');
        const cancel = makeBtn(xUrl, 'Cancel');

        li.appendChild(typeSelect);
        li.appendChild(durationSpan);
        li.appendChild(respContainer);
        li.appendChild(addWrap);
        li.appendChild(save);
        li.appendChild(cancel);

        save.addEventListener('click', async () => {
            const url = isNew ? `/calendar/${entryId}/recurrence/add` : `/calendar/${entryId}/recurrence/update`;
            const payload = {
                type: typeSelect.value,
                offset_days: parseInt(dayInput.value || '0'),
                offset_hours: parseInt(hourInput.value || '0'),
                offset_minutes: parseInt(minuteInput.value || '0'),
                responsible: responsible
            };
            if (!isNew) payload.recurrence_index = rindex;
            const resp = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify(payload)
            });
            if (resp.ok) {
                location.reload();
            } else {
                alert(`Failed to ${isNew ? 'add' : 'update'} recurrence`);
            }
        });
        cancel.addEventListener('click', () => {
            if (isNew) {
                li.remove();
                if (!recList || recList.children.length === 0) {
                    recContainer.textContent = 'None';
                }
            } else {
                location.reload();
            }
        });
    }

    document.querySelectorAll('.recurrence-item .edit-recurrence').forEach(btn => {
        btn.addEventListener('click', () => {
            const li = btn.closest('.recurrence-item');
            const rindex = parseInt(li.dataset.rindex);
            const originalType = li.dataset.type;
            const originalResp = JSON.parse(li.dataset.responsible || '[]');
            const offsetSeconds = parseInt(li.dataset.offsetSeconds || '0');
            setupRecurrenceEditor(li, rindex, originalType, originalResp, offsetSeconds, false);
        });
    });

    document.querySelectorAll('.recurrence-item .delete-recurrence').forEach(btn => {
        btn.addEventListener('click', async () => {
            const li = btn.closest('.recurrence-item');
            const rindex = parseInt(li.dataset.rindex);
            const resp = await fetch(`/calendar/${entryId}/recurrence/delete`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify({recurrence_index: rindex})
            });
            if (resp.ok) {
                location.reload();
            } else {
                alert('Failed to delete recurrence');
            }
        });
    });

    const addRecurrence = document.getElementById('add-recurrence');
    if (addRecurrence) {
        addRecurrence.addEventListener('click', () => {
            if (!recList) {
                recList = document.createElement('ul');
                recList.id = 'recurrence-list';
                recContainer.innerHTML = '';
                recContainer.appendChild(recList);
            }
            const li = document.createElement('li');
            li.className = 'recurrence-item';
            recList.appendChild(li);
            setupRecurrenceEditor(li, recList.children.length - 1, recurrenceTypes[0], [], 0, true);
        });
    }

    const descEdit = document.getElementById('edit-description');
    if (descEdit) {
        descEdit.addEventListener('click', () => {
            const container = document.getElementById('description-container');
            const textarea = document.createElement('textarea');
            const raw = atob(descEdit.dataset.desc || '');
            textarea.value = raw;
            textarea.className = 'inline-input';
            const save = makeBtn(diskUrl, 'Save');
            const cancel = makeBtn(xUrl, 'Cancel');
            container.innerHTML = '';
            container.appendChild(textarea);
            container.appendChild(save);
            container.appendChild(cancel);
            save.addEventListener('click', async () => {
                await fetch(`/calendar/${entryId}/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({description: textarea.value})
                });
                location.reload();
            });
            cancel.addEventListener('click', () => location.reload());
        });
    }

    const ttEdit = document.getElementById('edit-title-type');
    if (ttEdit) {
        ttEdit.addEventListener('click', () => {
            const container = document.getElementById('title-type');
            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.value = {{ entry.title|tojson }};
            titleInput.className = 'inline-input';
            const typeSelect = document.createElement('select');
            typeSelect.className = 'inline-input';
            {% for t in CalendarEntryType %}
            const opt{{ loop.index0 }} = document.createElement('option');
            opt{{ loop.index0 }}.value = "{{ t.value }}";
            opt{{ loop.index0 }}.textContent = "{{ t.value }}";
            if ("{{ t.value }}" === "{{ entry.type.value }}") opt{{ loop.index0 }}.selected = true;
            typeSelect.appendChild(opt{{ loop.index0 }});
            {% endfor %}
            const save = makeBtn(diskUrl, 'Save');
            const cancel = makeBtn(xUrl, 'Cancel');
            container.innerHTML = '';
            container.appendChild(titleInput);
            container.appendChild(typeSelect);
            container.appendChild(save);
            container.appendChild(cancel);
            save.addEventListener('click', async () => {
                await fetch(`/calendar/${entryId}/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title: titleInput.value, type: typeSelect.value})
                });
                location.reload();
            });
            cancel.addEventListener('click', () => location.reload());
        });
    }
});
</script>
{% endblock %}
