<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Chore Tracker{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
    <script>
    const CSRF_TOKEN = "{{ request.session['csrf_token'] }}";
    const origFetch = window.fetch.bind(window);
    window.fetch = function(url, options) {
        options = options || {};
        options.headers = options.headers || {};
        if ((options.method || 'GET').toUpperCase() === 'POST') {
            options.headers['X-CSRF-Token'] = CSRF_TOKEN;
        }
        return origFetch(url, options);
    };
    const origOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url) {
        this._method = method;
        return origOpen.apply(this, arguments);
    };
    const origSend = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.send = function(body) {
        if ((this._method || '').toUpperCase() === 'POST') {
            this.setRequestHeader('X-CSRF-Token', CSRF_TOKEN);
        }
        return origSend.apply(this, arguments);
    };
    </script>
</head>
<body>
    <nav class="navbar">
        <a href="{{ url_for('index') }}" class="nav-item">
            <img src="{{ url_for('static', path='home.svg') }}" alt="Home" class="icon">
        </a>
        {% set current_user = request.session.get('user') %}
        {% if current_user %}
        <div class="nav-actions">
            {% if user_has(current_user, 'events.read') or user_has(current_user, 'reminders.read') or user_has(current_user, 'chores.read') %}
            <div class="list-menu">
                <button class="icon-button" id="list-button">
                    <img src="{{ url_for('static', path='list.svg') }}" alt="List" class="icon">
                </button>
                <div class="dropdown" id="list-dropdown">
                    {% if user_has(current_user, 'events.read') %}
                    <a href="{{ url_for('list_calendar_entries', entry_type='Event') }}">Events</a>
                    {% endif %}
                    {% if user_has(current_user, 'reminders.read') %}
                    <a href="{{ url_for('list_calendar_entries', entry_type='Reminder') }}">Reminders</a>
                    {% endif %}
                    {% if user_has(current_user, 'chores.read') %}
                    <a href="{{ url_for('list_calendar_entries', entry_type='Chore') }}">Chores</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% if user_has(current_user, 'events.write') or user_has(current_user, 'reminders.write') or user_has(current_user, 'chores.write') %}
            <div class="create-menu">
                <button class="icon-button" id="create-button">
                    <img src="{{ url_for('static', path='plus.svg') }}" alt="Add" class="icon">
                </button>
                <div class="dropdown" id="create-dropdown">
                    {% if user_has(current_user, 'events.write') %}
                    <a href="{{ url_for('new_calendar_entry', entry_type='Event') }}">Event</a>
                    {% endif %}
                    {% if user_has(current_user, 'reminders.write') %}
                    <a href="{{ url_for('new_calendar_entry', entry_type='Reminder') }}">Reminder</a>
                    {% endif %}
                    {% if user_has(current_user, 'chores.write') %}
                    <a href="{{ url_for('new_calendar_entry', entry_type='Chore') }}">Chore</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            <div class="settings-menu">
                <button class="icon-button" id="settings-button">
                    <img src="{{ url_for('static', path='gear.svg') }}" alt="Settings" class="icon">
                </button>
                <div class="dropdown" id="settings-dropdown">
                    {% if current_user != 'Viewer' %}
                    <a href="{{ url_for('view_user', username=current_user) }}"><img src="{{ url_for('static', path='user.svg') }}" alt="View profile" class="icon"></a>
                    {% endif %}
                    {% if user_has(current_user, 'iam') %}
                    <a href="{{ url_for('list_users') }}"><img src="{{ url_for('static', path='users.svg') }}" alt="Manage users" class="icon"></a>
                    {% endif %}
                    {% if user_has(current_user, 'admin') %}
                    <a href="{{ url_for('system') }}"><img src="{{ url_for('static', path='system.svg') }}" alt="System" class="icon"></a>
                    {% endif %}
                    <a href="{{ url_for('logout') }}"><img src="{{ url_for('static', path='signout.svg') }}" alt="Sign out" class="icon"></a>
                </div>
            </div>
            <div class="user-menu">
                <button class="user-button"><img src="{{ url_for('profile_picture', username=current_user) }}" alt="{{ current_user }}" class="icon"></button>
                <div class="dropdown">
                    {% for u in all_users() if u.username != current_user %}
                    <a class="switch-user" data-username="{{ u.username }}" data-has-pin="{{ '1' if u.pin_hash else '0' }}" title="{{ u.username }}" href="{{ url_for('switch_user', username=u.username) }}?next={{ (request.url.path ~ ('?' ~ request.url.query if request.url.query else '')) | urlencode }}"><img src="{{ url_for('profile_picture', username=u.username) }}" alt="{{ u.username }}" class="icon"></a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </nav>
    <main class="content">
        {% set flash = request.session.pop('flash', None) %}
        {% if flash %}
        <div class="flash">{{ flash }}</div>
        {% endif %}
        {% block content %}{% endblock %}
    </main>
    <div id="pin-modal" class="pin-modal">
        <div class="pin-modal-content">
            <div id="pin-display"></div>
            <div class="keypad">
                <button class="key pin-key" data-value="1"><span class="num">1</span><span class="letters"></span></button>
                <button class="key pin-key" data-value="2"><span class="num">2</span><span class="letters">ABC</span></button>
                <button class="key pin-key" data-value="3"><span class="num">3</span><span class="letters">DEF</span></button>
                <button class="key pin-key" data-value="4"><span class="num">4</span><span class="letters">GHI</span></button>
                <button class="key pin-key" data-value="5"><span class="num">5</span><span class="letters">JKL</span></button>
                <button class="key pin-key" data-value="6"><span class="num">6</span><span class="letters">MNO</span></button>
                <button class="key pin-key" data-value="7"><span class="num">7</span><span class="letters">PQRS</span></button>
                <button class="key pin-key" data-value="8"><span class="num">8</span><span class="letters">TUV</span></button>
                <button class="key pin-key" data-value="9"><span class="num">9</span><span class="letters">WXYZ</span></button>
                <div></div>
                <button class="key pin-key" data-value="0"><span class="num">0</span><span class="letters"></span></button>
                <button class="key enter" id="pin-enter">&#x2192;</button>
            </div>
            <div id="pin-error" class="pin-error"></div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var createButton = document.getElementById('create-button');
        var createDropdown = document.getElementById('create-dropdown');
        var listButton = document.getElementById('list-button');
        var listDropdown = document.getElementById('list-dropdown');
        var settingsButton = document.getElementById('settings-button');
        var settingsDropdown = document.getElementById('settings-dropdown');

        function hideOtherDropdowns(except) {
            [createDropdown, listDropdown, settingsDropdown].forEach(function (dd) {
                if (dd && dd !== except) {
                    dd.classList.remove('show');
                }
            });
        }

        if (createButton && createDropdown) {
            createButton.addEventListener('click', function (e) {
                e.stopPropagation();
                hideOtherDropdowns(createDropdown);
                createDropdown.classList.toggle('show');
            });
            document.addEventListener('click', function (e) {
                if (!createDropdown.contains(e.target) && e.target !== createButton) {
                    createDropdown.classList.remove('show');
                }
            });
        }
        if (listButton && listDropdown) {
            listButton.addEventListener('click', function (e) {
                e.stopPropagation();
                hideOtherDropdowns(listDropdown);
                listDropdown.classList.toggle('show');
            });
            document.addEventListener('click', function (e) {
                if (!listDropdown.contains(e.target) && e.target !== listButton) {
                    listDropdown.classList.remove('show');
                }
            });
        }
        if (settingsButton && settingsDropdown) {
            settingsButton.addEventListener('click', function (e) {
                e.stopPropagation();
                hideOtherDropdowns(settingsDropdown);
                settingsDropdown.classList.toggle('show');
            });
            document.addEventListener('click', function (e) {
                if (!settingsDropdown.contains(e.target) && e.target !== settingsButton) {
                    settingsDropdown.classList.remove('show');
                }
            });
        }
        document.body.addEventListener('click', function (e) {
            if (e.target.classList.contains('help')) {
                alert(e.target.dataset.help);
            }
        });

        var switchLinks = document.querySelectorAll('.switch-user');
        var pinModal = document.getElementById('pin-modal');
        var pinDisplay = document.getElementById('pin-display');
        var pinError = document.getElementById('pin-error');
        var currentUser = null;
        var currentNext = '';
        var pinValue = '';

        function openPinModal(user, next) {
            currentUser = user;
            currentNext = next;
            pinValue = '';
            pinDisplay.textContent = '';
            pinError.textContent = '';
            pinModal.style.display = 'flex';
        }
        function closePinModal() {
            pinModal.style.display = 'none';
        }
        pinModal.addEventListener('click', function (e) {
            if (e.target === pinModal) {
                closePinModal();
            }
        });
        document.querySelectorAll('.pin-key').forEach(function (btn) {
            btn.addEventListener('click', function () {
                pinValue += this.dataset.value;
                pinDisplay.textContent = pinValue.replace(/./g, '•');
            });
        });
        document.getElementById('pin-enter').addEventListener('click', function () {
            performSwitch(currentUser, currentNext, pinValue);
        });
        switchLinks.forEach(function (link) {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                var username = this.dataset.username;
                var hasPin = this.dataset.hasPin === '1';
                var next = new URL(this.href).searchParams.get('next') || '';
                if (hasPin) {
                    openPinModal(username, next);
                } else {
                    performSwitch(username, next, '');
                }
            });
        });
        var switchTemplate = "{{ url_for('switch_user', username='__USER__') }}";
        function performSwitch(username, next, pin) {
            var url = switchTemplate.replace('__USER__', encodeURIComponent(username)) + '?next=' + encodeURIComponent(next);
            if (window.fetch) {
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
                    credentials: 'same-origin',
                    body: 'pin=' + encodeURIComponent(pin)
                }).then(function (resp) {
                    if (resp.ok) {
                        resp.json().then(function (data) {
                            closePinModal();
                            window.location.href = data.redirect;
                        });
                    } else {
                        resp.json().then(function (data) {
                            pinError.textContent = data.error || 'Invalid PIN';
                        });
                    }
                }).catch(function () {
                    pinError.textContent = 'Network error';
                });
            } else {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', url);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.setRequestHeader('Accept', 'application/json');
                xhr.withCredentials = true;
                xhr.onload = function () {
                    var data = {};
                    try {
                        data = JSON.parse(xhr.responseText);
                    } catch (e) {}
                    if (xhr.status >= 200 && xhr.status < 300) {
                        closePinModal();
                        window.location.href = data.redirect;
                    } else {
                        pinError.textContent = data.error || 'Invalid PIN';
                    }
                };
                xhr.onerror = function () {
                    pinError.textContent = 'Network error';
                };
                xhr.send('pin=' + encodeURIComponent(pin));
            }
        }

        var loggedInUser = "{{ request.session.get('user') }}";
        if (loggedInUser && loggedInUser !== 'Viewer') {
            setTimeout(function () {
                window.location.reload();
            }, ({{ LOGOUT_DURATION.total_seconds()|int }} + 1) * 1000);
        }
    });
    </script>
</body>
</html>
