{% extends "base.html" %}

{% block title %}Home - Chore Tracker{% endblock %}

{% block content %}
{% if overdue %}
<h2>Overdue</h2>
<ul class="time-list">
    {% for entry, period, responsible, has_note in overdue %}
    <li>
        {% for user in responsible %}
        <img src="{{ url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
        {% endfor %}
        <a href="{{ url_for('view_time_period', entry_id=entry.id, rindex=period.recurrence_index, iindex=period.instance_index) }}">{{ entry.title }}</a>{% if has_note %}<span class="note-marker">*</span>{% endif %}
        <span class="time-suffix" data-kind="due-ago" data-end="{{ period.end.timestamp() }}"></span>
        {% if entry.type == CalendarEntryType.Chore %}
        <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" data-action="add" />
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endif %}

{% if now_periods %}
<h2>Now</h2>
<ul class="time-list">
    {% for entry, period, completion, responsible, has_note in now_periods %}
    <li>
        {% for user in responsible %}
        <img src="{{ url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
        {% endfor %}
        <a href="{{ url_for('view_time_period', entry_id=entry.id, rindex=period.recurrence_index, iindex=period.instance_index) }}">{{ entry.title }}</a>{% if has_note %}<span class="note-marker">*</span>{% endif %}
        {% if entry.type == CalendarEntryType.Chore %}
        {% if completion %}
        <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" {% if completion.completed_by == request.session.get('user') or user_has(request.session.get('user'), 'chores.override_complete') %}data-action="remove"{% endif %} />
        {% else %}
        <span class="time-suffix" data-kind="due-in" data-end="{{ period.end.timestamp() }}"></span>
        <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" data-action="add" />
        {% endif %}
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endif %}

{% if upcoming %}
<h2>Upcoming</h2>
<ul class="time-list">
    {% for entry, period, responsible, has_note in upcoming %}
    <li>
        {% for user in responsible %}
        <img src="{{ url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
        {% endfor %}
        <a href="{{ url_for('view_time_period', entry_id=entry.id, rindex=period.recurrence_index, iindex=period.instance_index) }}">{{ entry.title }}</a>{% if has_note %}<span class="note-marker">*</span>{% endif %}
        <span class="time-suffix" data-kind="starts-in" data-start="{{ period.start.timestamp() }}"></span>
    </li>
    {% endfor %}
</ul>
{% endif %}

{% if not overdue and not now_periods and not upcoming %}
<p>Nothing to show.</p>
{% endif %}

<script>
const formatDuration = (seconds) => {
    const abs = Math.floor(Math.abs(seconds));
    const minute = 60, hour = 3600, day = 86400, week = 604800;
    const weeks = Math.floor(abs / week);
    const days = Math.floor((abs % week) / day);
    const hours = Math.floor((abs % day) / hour);
    const minutes = Math.floor((abs % hour) / minute);
    if (weeks > 0) return weeks + 'w' + (days > 0 ? days + 'd' : '');
    if (days > 0) return days + 'd' + (hours > 0 ? hours + 'h' : '');
    if (hours > 0) return hours + 'h' + (minutes > 0 ? minutes + 'm' : '');
    return minutes + 'm';
};

const serverNow = {{ now_ts|float }} * 1000;
const loadTime = Date.now();
const currentServerTime = () => new Date(serverNow + (Date.now() - loadTime));

function updateTimes() {
    const now = currentServerTime();
    let refresh = false;
    document.querySelectorAll('[data-kind="due-in"]').forEach(el => {
        const end = new Date(parseFloat(el.dataset.end) * 1000);
        const diff = (end - now) / 1000;
        if (diff <= 0) refresh = true;
        el.textContent = `(Due in ${formatDuration(diff)})`;
    });
    document.querySelectorAll('[data-kind="due-ago"]').forEach(el => {
        const end = new Date(parseFloat(el.dataset.end) * 1000);
        const diff = (now - end) / 1000;
        el.textContent = `(Due ${formatDuration(diff)} ago)`;
    });
    document.querySelectorAll('[data-kind="starts-in"]').forEach(el => {
        const start = new Date(parseFloat(el.dataset.start) * 1000);
        const diff = (start - now) / 1000;
        if (diff <= 0) refresh = true;
        el.textContent = `(Starts in ${formatDuration(diff)})`;
    });
    if (refresh) {
        location.reload();
    }
}
updateTimes();
setInterval(updateTimes, 1000);

document.querySelectorAll('.checkbox-icon[data-action]').forEach(el => {
    el.addEventListener('click', async () => {
        const entry = el.dataset.entry;
        const r = parseInt(el.dataset.rindex);
        const i = parseInt(el.dataset.iindex);
        const url = el.dataset.action === 'add'
            ? `/calendar/${entry}/completion`
            : `/calendar/${entry}/completion/remove`;
        const resp = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({recurrence_index: r, instance_index: i})
        });
        if (resp.status === 403) {
            const data = await resp.json();
            const flash = document.createElement('div');
            flash.className = 'flash';
            flash.textContent = data.message;
            document.body.prepend(flash);
            return;
        }
        location.reload();
    });
});
</script>
{% endblock %}

