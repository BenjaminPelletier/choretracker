{% extends "base.html" %}

{% block title %}Home - Chore Tracker{% endblock %}

{% block content %}
{% if overdue %}
<h2>Overdue</h2>
<ul class="time-list">
    {% for entry, period, responsible in overdue %}
    <li>
        {% for user in responsible %}
        <img src="{{ request.url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
        {% endfor %}
        <a href="{{ request.url_for('view_time_period', entry_id=entry.id, rindex=period.recurrence_index, iindex=period.instance_index) }}">{{ entry.title }}</a>
        <span class="time-suffix" data-kind="due-ago" data-end="{{ period.end.timestamp() }}"></span>
        {% if user_has(request.session.get('user'), 'chores.complete_overdue') %}
        <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" data-action="add" />
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endif %}

{% if now_periods %}
<h2>Now</h2>
<ul class="time-list">
    {% for entry, period, completion, responsible in now_periods %}
    <li>
        {% for user in responsible %}
        <img src="{{ request.url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
        {% endfor %}
        <a href="{{ request.url_for('view_time_period', entry_id=entry.id, rindex=period.recurrence_index, iindex=period.instance_index) }}">{{ entry.title }}</a>
        {% if entry.type == CalendarEntryType.Chore %}
        {% if not completion %}
        <span class="time-suffix" data-kind="due-in" data-end="{{ period.end.timestamp() }}"></span>
        {% endif %}
        {% if completion %}
        <img src="{{ url_for('static', path='checkbox-checked.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" {% if completion.completed_by == request.session.get('user') or user_has(request.session.get('user'), 'chores.override_complete') %}data-action="remove"{% endif %} />
        {% elif user_has(request.session.get('user'), 'chores.complete_on_time') %}
        <img src="{{ url_for('static', path='checkbox-empty.svg') }}" class="checkbox-icon" data-entry="{{ entry.id }}" data-rindex="{{ period.recurrence_index }}" data-iindex="{{ period.instance_index }}" data-action="add" />
        {% endif %}
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endif %}

{% if upcoming %}
<h2>Upcoming</h2>
<ul class="time-list">
    {% for entry, period, responsible in upcoming %}
    <li>
        {% for user in responsible %}
        <img src="{{ request.url_for('profile_picture', username=user) }}" alt="{{ user }}" class="profile-icon" />
        {% endfor %}
        <a href="{{ request.url_for('view_time_period', entry_id=entry.id, rindex=period.recurrence_index, iindex=period.instance_index) }}">{{ entry.title }}</a>
        <span class="time-suffix" data-kind="starts-in" data-start="{{ period.start.timestamp() }}"></span>
    </li>
    {% endfor %}
</ul>
{% endif %}

{% if not overdue and not now_periods and not upcoming %}
<p>Nothing to show.</p>
{% endif %}

<script>
const formatDuration = (seconds) => {
    const abs = Math.floor(Math.abs(seconds));
    const minute = 60, hour = 3600, day = 86400, week = 604800;
    if (abs < hour) return Math.floor(abs / minute) + 'm';
    if (abs < day) return Math.floor(abs / hour) + 'h';
    if (abs < week) return Math.floor(abs / day) + 'd';
    return Math.floor(abs / week) + 'w';
};

const serverNow = {{ now_ts|float }} * 1000;
const loadTime = Date.now();
const currentServerTime = () => new Date(serverNow + (Date.now() - loadTime));

function updateTimes() {
    const now = currentServerTime();
    let refresh = false;
    document.querySelectorAll('[data-kind="due-in"]').forEach(el => {
        const end = new Date(parseFloat(el.dataset.end) * 1000);
        const diff = (end - now) / 1000;
        if (diff <= 0) refresh = true;
        el.textContent = `(Due in ${formatDuration(diff)})`;
    });
    document.querySelectorAll('[data-kind="due-ago"]').forEach(el => {
        const end = new Date(parseFloat(el.dataset.end) * 1000);
        const diff = (now - end) / 1000;
        el.textContent = `(Due ${formatDuration(diff)} ago)`;
    });
    document.querySelectorAll('[data-kind="starts-in"]').forEach(el => {
        const start = new Date(parseFloat(el.dataset.start) * 1000);
        const diff = (start - now) / 1000;
        if (diff <= 0) refresh = true;
        el.textContent = `(Starts in ${formatDuration(diff)})`;
    });
    if (refresh) {
        location.reload();
    }
}
updateTimes();
setInterval(updateTimes, 1000);

document.querySelectorAll('.checkbox-icon[data-action]').forEach(el => {
    el.addEventListener('click', async () => {
        const entry = el.dataset.entry;
        const r = parseInt(el.dataset.rindex);
        const i = parseInt(el.dataset.iindex);
        const url = el.dataset.action === 'add'
            ? `/calendar/${entry}/completion`
            : `/calendar/${entry}/completion/remove`;
        await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({recurrence_index: r, instance_index: i})
        });
        location.reload();
    });
});
</script>
{% endblock %}

